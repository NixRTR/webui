import{j as e,C as i,L as A,S as B,T as Z,a as F,g as j}from"./ui-vendor-BVL8hT-S.js";import{u as ee,r as n}from"./react-vendor-DKKOAuGG.js";import{u as se,S as R,N as O}from"./useMetrics-CHtIqUNb.js";import{a as v}from"./index-9dKHPhJj.js";import{C as p}from"./CustomTooltip-h6IVXsCv.js";import{R as u,L as S,C as b,X as k,Y as h,T as _,a as N,b as d,A as te,c as w}from"./charts-B4vmDJji.js";import"./http-vendor-B9ygI19o.js";function xe(){const o=localStorage.getItem("access_token"),E=localStorage.getItem("username")||"Unknown",W=ee(),[f,g]=n.useState(!1),[x,L]=n.useState(!1),[C,$]=n.useState(null),[c,H]=n.useState("1h"),[y,P]=n.useState(""),[m,U]=n.useState(10),[a,V]=n.useState(null),[K,D]=n.useState(null),{connectionStatus:I}=se(o),T=async()=>{await v.logout(),W("/login")};n.useEffect(()=>{const s=async()=>{if(o)try{const r=await v.getCakeStatus();L(r.enabled),$(r.interface||null)}catch(r){console.error("Failed to check CAKE status:",r),L(!1)}};s();const t=setInterval(s,6e4);return()=>clearInterval(t)},[o]),n.useEffect(()=>{const s=async()=>{if(!(!o||!x))try{const r=await v.getCurrentCakeStats();r&&V(r)}catch(r){console.error("Failed to fetch current CAKE stats:",r)}};s();const t=setInterval(s,m*1e3);return()=>clearInterval(t)},[o,x,m]),n.useEffect(()=>{const s=async()=>{if(!(!o||!x))try{const r=c==="custom"?y:c;if(!r||c==="custom"&&!y){D(null);return}const Q=await v.getCakeHistory(r,C??void 0);D(Q)}catch(r){console.error("Failed to fetch CAKE history:",r)}};s();const t=setInterval(s,m*1e3);return()=>clearInterval(t)},[o,x,c,y,m,C]);const X=()=>{if(!a?.classes)return null;const s=[];return Object.values(a.classes).forEach(t=>{t.av_delay_ms!==void 0&&s.push(t.av_delay_ms)}),s.length>0?s.reduce((t,r)=>t+r,0)/s.length:null},Y=()=>{if(!a?.classes)return 0;let s=0;return Object.values(a.classes).forEach(t=>{t.bytes&&(s+=t.bytes)}),0},G=()=>{if(!a?.classes)return{drops:0,marks:0};let s=0,t=0;return Object.values(a.classes).forEach(r=>{r.drops&&(s+=r.drops),r.marks&&(t+=r.marks)}),{drops:s,marks:t}},l=K?.data?K.data.map(s=>({time:new Date(s.timestamp).toLocaleTimeString(),timestamp:s.timestamp,rate_mbps:s.rate_mbps||0,bulk_av_delay:s.classes?.bulk?.av_delay_ms||0,bulk_pk_delay:s.classes?.bulk?.pk_delay_ms||0,besteffort_av_delay:s.classes?.["best-effort"]?.av_delay_ms||0,besteffort_pk_delay:s.classes?.["best-effort"]?.pk_delay_ms||0,video_av_delay:s.classes?.video?.av_delay_ms||0,video_pk_delay:s.classes?.video?.pk_delay_ms||0,voice_av_delay:s.classes?.voice?.av_delay_ms||0,voice_pk_delay:s.classes?.voice?.pk_delay_ms||0,bulk_bytes:s.classes?.bulk?.bytes||0,besteffort_bytes:s.classes?.["best-effort"]?.bytes||0,video_bytes:s.classes?.video?.bytes||0,voice_bytes:s.classes?.voice?.bytes||0,bulk_drops:s.classes?.bulk?.drops||0,besteffort_drops:s.classes?.["best-effort"]?.drops||0,video_drops:s.classes?.video?.drops||0,voice_drops:s.classes?.voice?.drops||0,bulk_marks:s.classes?.bulk?.marks||0,besteffort_marks:s.classes?.["best-effort"]?.marks||0,video_marks:s.classes?.video?.marks||0,voice_marks:s.classes?.voice?.marks||0})):[],M=X(),z=Y(),{drops:q,marks:J}=G();return x?e.jsxs("div",{className:"flex h-screen",children:[e.jsx(R,{onLogout:T,isOpen:f,onClose:()=>g(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(O,{hostname:"nixos-router",username:E,connectionStatus:I,onMenuClick:()=>g(!f)}),e.jsx("div",{className:"sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 md:px-6 py-3 shadow-sm",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-3",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"Traffic Shaping"}),e.jsxs("div",{className:"flex flex-wrap gap-2 md:gap-4 items-end",children:[e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx(A,{htmlFor:"global-range",value:"Time Range",className:"text-xs mb-1"}),e.jsxs(B,{id:"global-range",sizing:"sm",value:c,onChange:s=>H(s.target.value),children:[e.jsx("option",{value:"10m",children:"10 minutes"}),e.jsx("option",{value:"30m",children:"30 minutes"}),e.jsx("option",{value:"1h",children:"1 hour"}),e.jsx("option",{value:"3h",children:"3 hours"}),e.jsx("option",{value:"6h",children:"6 hours"}),e.jsx("option",{value:"12h",children:"12 hours"}),e.jsx("option",{value:"1d",children:"1 day"}),e.jsx("option",{value:"3d",children:"3 days"}),e.jsx("option",{value:"7d",children:"7 days"}),e.jsx("option",{value:"custom",children:"Custom"})]})]}),c==="custom"&&e.jsxs("div",{className:"min-w-[100px]",children:[e.jsx(A,{htmlFor:"global-custom",value:"Custom",className:"text-xs mb-1"}),e.jsx(Z,{id:"global-custom",sizing:"sm",placeholder:"e.g., 45m",value:y,onChange:s=>P(s.target.value)})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx(A,{htmlFor:"global-refresh",value:"Update Every",className:"text-xs mb-1"}),e.jsxs(B,{id:"global-refresh",sizing:"sm",value:m,onChange:s=>U(Number(s.target.value)),children:[e.jsx("option",{value:1,children:"1 second"}),e.jsx("option",{value:5,children:"5 seconds"}),e.jsx("option",{value:10,children:"10 seconds"}),e.jsx("option",{value:30,children:"30 seconds"}),e.jsx("option",{value:60,children:"1 minute"})]})]})]})]})}),e.jsxs("main",{className:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-900",children:[e.jsx(i,{className:"mb-6",children:e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"CAKE Status"}),e.jsxs("div",{className:"flex gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Interface: "}),e.jsx(F,{color:"info",children:C||"Unknown"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Status: "}),e.jsx(F,{color:"success",children:"Enabled"})]}),a&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Last Updated: "}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:new Date(a.timestamp).toLocaleTimeString()})]})]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsx(i,{children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Detected Bandwidth"}),e.jsx("p",{className:"text-3xl font-bold",children:a?.rate_mbps?`${a.rate_mbps.toFixed(2)}`:"--"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500 mt-1",children:"Mbps"})]})}),e.jsx(i,{children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Average Latency"}),e.jsx("p",{className:"text-3xl font-bold",children:M?`${M.toFixed(2)}`:"--"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500 mt-1",children:"ms"})]})}),e.jsx(i,{children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Total Throughput"}),e.jsx("p",{className:"text-3xl font-bold",children:z>0?`${z.toFixed(2)}`:"--"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500 mt-1",children:"Mbps"})]})}),e.jsx(i,{children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Packet Drops/Marks"}),e.jsxs("p",{className:"text-2xl font-bold",children:[q," / ",J]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500 mt-1",children:"drops / marks"})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 mb-6",children:[l.length>0&&e.jsxs(i,{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Bandwidth Detection"}),e.jsx(u,{width:"100%",height:250,children:e.jsxs(S,{data:l,children:[e.jsx(b,{strokeDasharray:"3 3"}),e.jsx(k,{dataKey:"time",tick:{fontSize:12},interval:Math.floor(l.length/8)}),e.jsx(h,{tick:{fontSize:12},label:{value:"Mbps",angle:-90,position:"insideLeft"}}),e.jsx(_,{content:e.jsx(p,{})}),e.jsx(N,{}),e.jsx(d,{type:"monotone",dataKey:"rate_mbps",stroke:"#3b82f6",name:"Rate (Mbps)",strokeWidth:2,dot:!1,isAnimationActive:!1})]})})]}),l.length>0&&e.jsxs(i,{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Latency Over Time"}),e.jsx(u,{width:"100%",height:300,children:e.jsxs(S,{data:l,children:[e.jsx(b,{strokeDasharray:"3 3"}),e.jsx(k,{dataKey:"time",tick:{fontSize:12},interval:Math.floor(l.length/8)}),e.jsx(h,{tick:{fontSize:12},label:{value:"ms",angle:-90,position:"insideLeft"}}),e.jsx(_,{content:e.jsx(p,{})}),e.jsx(N,{}),e.jsx(d,{type:"monotone",dataKey:"bulk_av_delay",stroke:"#6b7280",name:"Bulk Avg",strokeWidth:2,dot:!1,isAnimationActive:!1}),e.jsx(d,{type:"monotone",dataKey:"besteffort_av_delay",stroke:"#3b82f6",name:"Best Effort Avg",strokeWidth:2,dot:!1,isAnimationActive:!1}),e.jsx(d,{type:"monotone",dataKey:"video_av_delay",stroke:"#f97316",name:"Video Avg",strokeWidth:2,dot:!1,isAnimationActive:!1}),e.jsx(d,{type:"monotone",dataKey:"voice_av_delay",stroke:"#ef4444",name:"Voice Avg",strokeWidth:2,dot:!1,isAnimationActive:!1})]})})]}),l.length>0&&e.jsxs(i,{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Traffic Class Distribution (Bytes)"}),e.jsx(u,{width:"100%",height:300,children:e.jsxs(te,{data:l,children:[e.jsx(b,{strokeDasharray:"3 3"}),e.jsx(k,{dataKey:"time",tick:{fontSize:12},interval:Math.floor(l.length/8)}),e.jsx(h,{tick:{fontSize:12},label:{value:"Bytes",angle:-90,position:"insideLeft"}}),e.jsx(_,{content:e.jsx(p,{})}),e.jsx(N,{}),e.jsx(w,{type:"monotone",dataKey:"bulk_bytes",stackId:"1",stroke:"#6b7280",fill:"#6b7280",name:"Bulk"}),e.jsx(w,{type:"monotone",dataKey:"besteffort_bytes",stackId:"1",stroke:"#3b82f6",fill:"#3b82f6",name:"Best Effort"}),e.jsx(w,{type:"monotone",dataKey:"video_bytes",stackId:"1",stroke:"#f97316",fill:"#f97316",name:"Video"}),e.jsx(w,{type:"monotone",dataKey:"voice_bytes",stackId:"1",stroke:"#ef4444",fill:"#ef4444",name:"Voice"})]})})]}),l.length>0&&e.jsxs(i,{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Packet Drops and ECN Marks"}),e.jsx(u,{width:"100%",height:300,children:e.jsxs(S,{data:l,children:[e.jsx(b,{strokeDasharray:"3 3"}),e.jsx(k,{dataKey:"time",tick:{fontSize:12},interval:Math.floor(l.length/8)}),e.jsx(h,{yAxisId:"left",tick:{fontSize:12},label:{value:"Drops",angle:-90,position:"insideLeft"}}),e.jsx(h,{yAxisId:"right",orientation:"right",tick:{fontSize:12},label:{value:"Marks",angle:90,position:"insideRight"}}),e.jsx(_,{content:e.jsx(p,{})}),e.jsx(N,{}),e.jsx(d,{yAxisId:"left",type:"monotone",dataKey:"bulk_drops",stroke:"#ef4444",name:"Bulk Drops",strokeWidth:2,dot:!1,isAnimationActive:!1}),e.jsx(d,{yAxisId:"right",type:"monotone",dataKey:"bulk_marks",stroke:"#fbbf24",name:"Bulk Marks",strokeWidth:2,dot:!1,isAnimationActive:!1})]})})]})]}),a?.classes&&Object.keys(a.classes).length>0&&e.jsxs(i,{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Traffic Class Details"}),e.jsx(j,{children:Object.entries(a.classes).map(([s,t])=>e.jsxs(j.Panel,{children:[e.jsx(j.Title,{className:"capitalize",children:s}),e.jsx(j.Content,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Peak Delay"}),e.jsx("p",{className:"text-lg font-semibold",children:t.pk_delay_ms!==void 0?`${t.pk_delay_ms.toFixed(2)} ms`:"--"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Average Delay"}),e.jsx("p",{className:"text-lg font-semibold",children:t.av_delay_ms!==void 0?`${t.av_delay_ms.toFixed(2)} ms`:"--"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Sparse Delay"}),e.jsx("p",{className:"text-lg font-semibold",children:t.sp_delay_ms!==void 0?`${t.sp_delay_ms.toFixed(2)} ms`:"--"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Bytes"}),e.jsx("p",{className:"text-lg font-semibold",children:t.bytes!==void 0?`${(t.bytes/1024/1024).toFixed(2)} MB`:"--"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Packets"}),e.jsx("p",{className:"text-lg font-semibold",children:t.packets!==void 0?t.packets.toLocaleString():"--"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Drops"}),e.jsx("p",{className:"text-lg font-semibold text-red-600",children:t.drops!==void 0?t.drops.toLocaleString():"--"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Marks"}),e.jsx("p",{className:"text-lg font-semibold text-yellow-600",children:t.marks!==void 0?t.marks.toLocaleString():"--"})]})]})})]},s))})]}),a&&(a.way_inds!==void 0||a.way_miss!==void 0||a.way_cols!==void 0)&&e.jsxs(i,{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Hash Performance"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Indirect Hits"}),e.jsx("p",{className:"text-2xl font-bold",children:a.way_inds!==void 0?a.way_inds.toLocaleString():"--"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Misses"}),e.jsx("p",{className:"text-2xl font-bold",children:a.way_miss!==void 0?a.way_miss.toLocaleString():"--"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Collisions"}),e.jsx("p",{className:"text-2xl font-bold",children:a.way_cols!==void 0?a.way_cols.toLocaleString():"--"})]})]}),a.way_inds!==void 0&&a.way_miss!==void 0&&e.jsxs("div",{className:"mt-4 text-center text-sm text-gray-600 dark:text-gray-400",children:["Hit Rate: ",(a.way_inds/(a.way_inds+a.way_miss)*100).toFixed(2),"%"]})]}),l.length===0&&a===null&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"No CAKE statistics available. Ensure CAKE is properly configured."})})]})]})]}):e.jsxs("div",{className:"flex h-screen",children:[e.jsx(R,{onLogout:T,isOpen:f,onClose:()=>g(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(O,{hostname:"nixos-router",username:E,connectionStatus:I,onMenuClick:()=>g(!f)}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsx(i,{className:"max-w-md w-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"CAKE Traffic Shaping Disabled"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"CAKE traffic shaping is not enabled on this router."}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-500 mt-2",children:"Enable CAKE in router-config.nix to view traffic shaping statistics."})]})})})]})]})}export{xe as TrafficShaping};
