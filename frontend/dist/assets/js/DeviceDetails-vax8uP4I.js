import{j as e,C as p,B as k,a as x,b as a}from"./ui-vendor-B64yKeUt.js";import{i as R,u as F,a as c,L as w}from"./react-vendor-4URc7N9U.js";import{u as V,S as _,N as S}from"./useMetrics-CzXyktkO.js";import{a as m}from"./index-CT0BUscA.js";import"./http-vendor-B9ygI19o.js";const C=3e3,z=60;function J(){const{macAddress:l}=R(),n=localStorage.getItem("access_token"),u=localStorage.getItem("username")||"Unknown",D=F(),[t,P]=c.useState(null),[L,H]=c.useState(null),[r,j]=c.useState(null),[f,y]=c.useState(null),[O,E]=c.useState([]),[o,d]=c.useState(!1),[g,h]=c.useState(!1),{connectionStatus:N}=V(n),v=async()=>{await m.logout(),D("/login")},I=c.useCallback(async()=>{if(!(!n||!l)){H(null);try{const s=await m.getDeviceByMac(l);P(s)}catch(s){P(null),H(s&&typeof s=="object"&&"response"in s&&s.response?.status===404?"Device not found":"Failed to load device")}}},[n,l]),T=c.useCallback(async()=>{if(!(!n||!l)){y(null);try{const s=await m.getDevicePortScan(l);j(s)}catch(s){(s&&typeof s=="object"&&"response"in s?s.response?.status:void 0)===404?(j(null),y(null)):(j(null),y("Failed to load port scan"))}}},[n,l]),M=c.useCallback(async()=>{if(!(!n||!l))try{const s=await m.getDeviceIpHistory(l);E(s)}catch{E([])}},[n,l]);c.useEffect(()=>{I()},[I]),c.useEffect(()=>{l&&(T(),M())},[l,T,M]);const A=async()=>{if(!(!n||!l||g)){h(!0);try{await m.triggerDevicePortScan(l);let s=0;const i=async()=>{try{const b=await m.getDevicePortScan(l);j(b),(b.scan_status==="pending"||b.scan_status==="in_progress")&&s<z?(s+=1,setTimeout(i,C)):h(!1)}catch{s<z?(s+=1,setTimeout(i,C)):h(!1)}};setTimeout(i,C)}catch{h(!1)}}};if(L&&!t)return e.jsxs("div",{className:"flex h-screen",children:[e.jsx(_,{onLogout:v,isOpen:o,onClose:()=>d(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(S,{hostname:"nixos-router",username:u,connectionStatus:N,onMenuClick:()=>d(!o)}),e.jsxs("main",{className:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-900",children:[e.jsxs("div",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:[e.jsx(w,{to:"/devices",className:"hover:text-gray-900 dark:hover:text-gray-100",children:"Devices"}),e.jsx("span",{className:"mx-2",children:"›"}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:"Device details"})]}),e.jsxs(p,{children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:L}),e.jsx(k,{color:"gray",onClick:()=>D("/devices"),children:"Back to devices"})]})]})]})]});if(!t)return e.jsxs("div",{className:"flex h-screen",children:[e.jsx(_,{onLogout:v,isOpen:o,onClose:()=>d(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(S,{hostname:"nixos-router",username:u,connectionStatus:N,onMenuClick:()=>d(!o)}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-gray-900 dark:border-gray-100"}),e.jsx("p",{className:"mt-2 text-gray-600 dark:text-gray-400",children:"Loading device..."})]})})]})]});const B=t.hostname||t.ip_address||t.mac_address;return e.jsxs("div",{className:"flex h-screen",children:[e.jsx(_,{onLogout:v,isOpen:o,onClose:()=>d(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(S,{hostname:"nixos-router",username:u,connectionStatus:N,onMenuClick:()=>d(!o)}),e.jsxs("main",{className:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-900",children:[e.jsxs("div",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:[e.jsx(w,{to:"/devices",className:"hover:text-gray-900 dark:hover:text-gray-100",children:"Devices"}),e.jsx("span",{className:"mx-2",children:"›"}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:B}),e.jsx("span",{className:"mx-2",children:"›"}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:"Device details"})]}),e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2 items-center",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"Device details"}),e.jsx(k,{size:"sm",color:"gray",as:w,to:`/devices/${t.ip_address}`,children:"View usage"})]}),e.jsxs(p,{className:"mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Device information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"MAC address"}),e.jsx("span",{className:"font-mono ml-2",children:t.mac_address})]}),e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"Current IP"}),e.jsx("span",{className:"font-mono ml-2",children:t.ip_address})]}),e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"Hostname"}),e.jsx("span",{className:"ml-2",children:t.hostname||"—"})]}),e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"Vendor"}),e.jsx("span",{className:"ml-2",children:t.vendor||"—"})]}),e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"Network"}),e.jsx(x,{color:t.network==="homelab"?"info":"purple",size:"sm",className:"ml-2",children:t.network.toUpperCase()})]}),e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"Status"}),e.jsx(x,{color:t.is_online?"success":"gray",size:"sm",className:"ml-2",children:t.is_online?"Online":"Offline"})]}),e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"Type"}),e.jsx(x,{color:t.is_dhcp?t.is_static?"success":"warning":"gray",size:"sm",className:"ml-2",children:t.is_static?"Static DHCP":t.is_dhcp?"Dynamic":"Static IP"})]}),e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"Last seen"}),e.jsx("span",{className:"ml-2",children:new Date(t.last_seen).toLocaleString()})]}),t.favorite&&e.jsxs("div",{className:"flex justify-between md:block",children:[e.jsx("span",{className:"text-gray-500",children:"Favorite"}),e.jsx(x,{color:"warning",size:"sm",className:"ml-2",children:"★"})]})]})]}),e.jsxs(p,{className:"mb-6",children:[e.jsxs("div",{className:"flex flex-wrap justify-between items-center gap-2 mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Open ports"}),e.jsx(k,{size:"sm",color:"gray",onClick:A,isProcessing:g,disabled:g,children:g?"Scanning...":"Scan ports"})]}),f&&e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 mb-2",children:f}),!r&&!f?e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:'No scan yet. Click "Scan ports" to run a port scan.'}):r?e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center gap-2",children:[e.jsx(x,{color:r.scan_status==="completed"?"success":r.scan_status==="failed"?"failure":r.scan_status==="in_progress"?"warning":"gray",children:r.scan_status.toUpperCase()}),e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Started: ",new Date(r.scan_started_at).toLocaleString()]}),r.scan_completed_at&&e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Completed: ",new Date(r.scan_completed_at).toLocaleString()]})]}),r.error_message&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded",children:e.jsxs("p",{className:"text-sm text-red-800 dark:text-red-200",children:[e.jsx("strong",{children:"Error:"})," ",r.error_message]})}),r.ports.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(a,{children:[e.jsxs(a.Head,{children:[e.jsx(a.HeadCell,{children:"Port"}),e.jsx(a.HeadCell,{children:"Protocol"}),e.jsx(a.HeadCell,{children:"State"}),e.jsx(a.HeadCell,{children:"Service"}),e.jsx(a.HeadCell,{children:"Version"}),e.jsx(a.HeadCell,{children:"Product"})]}),e.jsx(a.Body,{children:r.ports.map((s,i)=>e.jsxs(a.Row,{children:[e.jsx(a.Cell,{className:"font-mono",children:s.port}),e.jsx(a.Cell,{className:"uppercase",children:s.protocol}),e.jsx(a.Cell,{children:e.jsx(x,{color:s.state==="open"?"success":s.state==="closed"?"gray":s.state==="filtered"?"warning":"gray",size:"sm",children:s.state})}),e.jsx(a.Cell,{children:s.service_name||"—"}),e.jsx(a.Cell,{children:s.service_version||"—"}),e.jsx(a.Cell,{children:s.service_product||"—"})]},i))})]})}):r.scan_status==="completed"?e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"No open ports found"}):e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Scan in progress or no results yet"})]}):null]}),e.jsxs(p,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"IP address history"}),O.length===0?e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"No history (current IP only, or no port scans yet)"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(a,{children:[e.jsxs(a.Head,{children:[e.jsx(a.HeadCell,{children:"IP address"}),e.jsx(a.HeadCell,{children:"Last seen"})]}),e.jsx(a.Body,{children:O.map((s,i)=>e.jsxs(a.Row,{children:[e.jsx(a.Cell,{className:"font-mono",children:s.ip_address}),e.jsx(a.Cell,{children:new Date(s.last_seen).toLocaleString()})]},i))})]})})]})]})]})]})}export{J as DeviceDetails};
