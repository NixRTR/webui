import{j as e,C as U,L as p,S as w,p as W,B as $,u as z,f as M}from"./ui-vendor-B64yKeUt.js";import{u as G,a as s}from"./react-vendor-4URc7N9U.js";import{u as V,S as J,N as K}from"./useMetrics-CzXyktkO.js";import{a as k}from"./index-CT0BUscA.js";import"./http-vendor-B9ygI19o.js";const Q="",L=[{id:"system",label:"System Log"},{id:"dnsmasq-lan",label:"LAN DNS/DHCP"},{id:"dnsmasq-homelab",label:"HOMELAB DNS/DHCP"},{id:"nginx",label:"Nginx"},{id:"router-webui-backend",label:"WebUI Backend"},{id:"router-webui-celery-parallel",label:"Parallel Celery Worker"},{id:"router-webui-celery-sequential",label:"Sequential Celery Worker"},{id:"router-webui-celery-aggregation",label:"Aggregation Celery Worker"},{id:"postgresql",label:"Database"},{id:"sshd",label:"SSH"}],X=[100,200,500,1e3,2e3],Y=[{value:"all",label:"All"},{value:"err",label:"Error"},{value:"warning",label:"Warning"},{value:"info",label:"Info"},{value:"debug",label:"Debug"}];function te(){const n=localStorage.getItem("access_token"),C=localStorage.getItem("username")||"Unknown",E=G(),[R,y]=s.useState(!1),[r,O]=s.useState(L[0].id),[i,I]=s.useState(500),[t,A]=s.useState("all"),[l,S]=s.useState(!1),[x,g]=s.useState(""),[f,c]=s.useState(!1),[j,u]=s.useState(null),m=s.useRef(null),h=s.useRef(null),{connectionStatus:F}=V(n),v=s.useCallback(async(a,b=t)=>{if(!(!r||!n)){c(!0),u(null);try{const d=await k.getLogs(r,a,b);g(d)}catch(d){const o=d instanceof Error?d.message:"Failed to load logs";u(o),g("")}finally{c(!1)}}},[r,n,t]);s.useEffect(()=>{!l&&r&&v(i,t)},[r,i,t,l,v]),s.useEffect(()=>{if(!l||!r||!n)return;g(""),u(null),c(!0);const a=new AbortController;m.current=a;const b=new URLSearchParams({service:r,lines:String(i),follow:"true"});t&&t!=="all"&&b.set("priority",t);const d=`${Q}/api/logs?${b.toString()}`;return(async()=>{try{const o=await fetch(d,{headers:{Authorization:`Bearer ${n}`},signal:a.signal});if(!o.ok||!o.body){u(`HTTP ${o.status}`),c(!1);return}c(!1);const D=o.body.getReader(),H=new TextDecoder;for(;;){const{done:_,value:B}=await D.read();if(_)break;g(q=>q+H.decode(B,{stream:!0}))}}catch(o){o.name!=="AbortError"&&u(o.message),c(!1)}finally{S(!1)}})(),()=>{a.abort(),m.current=null}},[l,r,i,t,n]),s.useEffect(()=>{h.current&&x&&(h.current.scrollTop=h.current.scrollHeight)},[x]);const P=async()=>{await k.logout(),E("/login")},N=a=>{!a&&m.current&&(m.current.abort(),m.current=null),S(a)},T=()=>{l&&N(!1),v(i,t)};return e.jsxs("div",{className:"flex h-screen",children:[e.jsx(J,{onLogout:P,isOpen:R,onClose:()=>y(!1)}),e.jsxs("div",{className:"flex flex-1 flex-col min-w-0",children:[e.jsx(K,{hostname:"nixos-router",username:C,connectionStatus:F,onMenuClick:()=>y(!0)}),e.jsx("main",{className:"flex-1 overflow-auto p-4",children:e.jsx("div",{className:"mx-auto max-w-full",children:e.jsxs(U,{children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Logs"}),e.jsxs("div",{className:"mb-4 flex flex-wrap items-end gap-4",children:[e.jsxs("div",{className:"min-w-[200px]",children:[e.jsx(p,{htmlFor:"log-source",className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Log to view"}),e.jsx(w,{id:"log-source",value:r,onChange:a=>O(a.target.value),disabled:l,children:L.map(a=>e.jsx("option",{value:a.id,children:a.label},a.id))})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx(p,{htmlFor:"lines",className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Lines to view"}),e.jsx(w,{id:"lines",value:i,onChange:a=>I(Number(a.target.value)),disabled:l,children:X.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"min-w-[140px]",children:[e.jsx(p,{htmlFor:"log-level",className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Log level"}),e.jsx(w,{id:"log-level",value:t,onChange:a=>A(a.target.value),disabled:l,children:Y.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{id:"follow",checked:l,onChange:a=>N(a.target.checked),disabled:f}),e.jsx(p,{htmlFor:"follow",className:"cursor-pointer text-sm text-gray-700 dark:text-gray-300",children:"Follow log (live tail, includes selected lines)"})]}),e.jsxs($,{size:"sm",onClick:T,disabled:f||l,children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),"Refresh"]})]}),j&&e.jsx("p",{className:"mb-2 text-sm text-red-600 dark:text-red-400",children:j}),f&&!x&&e.jsxs("div",{className:"flex items-center gap-2 py-4",children:[e.jsx(M,{size:"sm"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:l?"Connecting...":"Loading logs..."})]}),e.jsx("pre",{ref:h,className:"max-h-[70vh] overflow-auto rounded bg-gray-900 p-3 text-xs text-gray-100 font-mono whitespace-pre-wrap break-words",children:x||(f?"":"Select a log and click Refresh or enable Follow.")})]})})})]})]})}export{te as Logs};
