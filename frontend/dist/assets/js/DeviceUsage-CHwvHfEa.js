import{j as e,C as ye,L as C,S as I,T as ae,b as n,a as te,B as _,M as P}from"./ui-vendor-D-qqm1E2.js";import{u as Ce,r as l}from"./react-vendor-DKKOAuGG.js";import{u as _e,S as ke,N as we}from"./useMetrics-C2INNNRD.js";import{a as L}from"./index-BaCGhgyP.js";import{R as Ne,L as Se,C as Be,X as Me,Y as De,T as Ie,a as Le,b as re}from"./charts-_iF2RbR3.js";import"./http-vendor-B9ygI19o.js";function Oe(){const i=localStorage.getItem("access_token"),ne=localStorage.getItem("username")||"Unknown",A=Ce(),[le,oe]=l.useState([]),[g,K]=l.useState({}),[ie,k]=l.useState([]),[ce,T]=l.useState([]),[V,X]=l.useState(!1),[z,Y]=l.useState(!1),[p,de]=l.useState(null),[he,R]=l.useState([]),[j,me]=l.useState("1h"),[x,G]=l.useState(""),[H,ue]=l.useState(10),[F,xe]=l.useState("raw"),[h,ge]=l.useState("1h"),[m,J]=l.useState(""),[pe,q]=l.useState({}),[M,je]=l.useState(null),[O,Q]=l.useState("asc"),ve=s=>["dl","ul"].includes(s),{connectionStatus:fe}=_e(i),be=async()=>{await L.logout(),A("/login")};l.useEffect(()=>{const s=async()=>{if(i)try{const a=await fetch("/api/devices/all",{headers:{Authorization:`Bearer ${i}`}});if(a.ok){const o=(await a.json()).filter(c=>c.ip_address.startsWith("192.168.2.")||c.ip_address.startsWith("192.168.3."));oe(o)}}catch(a){console.error("Failed to fetch devices:",a)}};s();const t=setInterval(s,1e4);return()=>clearInterval(t)},[i]),l.useEffect(()=>{const s=async()=>{if(!i)return;const a=h==="custom"?m:h;if(!a||h==="custom"&&!v(a)){q({});return}try{const r=await L.getInterfaceTotals(a);q(r)}catch(r){console.error("Failed to fetch interface stats:",r)}};s();const t=setInterval(s,6e4);return()=>clearInterval(t)},[i,h,m]),l.useEffect(()=>{const s=async()=>{if(i)try{const a=await fetch("/api/devices/blocked",{headers:{Authorization:`Bearer ${i}`}});if(a.ok){const r=await a.json();k(r.ipv4||[]),T((r.macs||[]).map(o=>o.toLowerCase()))}}catch{}};s();const t=setInterval(s,1e4);return()=>clearInterval(t)},[i]);const v=s=>!s||s.trim()===""?!1:/^(\d+)([mhdwMy])$/i.test(s.trim());l.useEffect(()=>{const s=async()=>{if(!i)return;const a=h==="custom"?m:h;if(!a||h==="custom"&&!v(a)){K({});return}try{let r="raw";a.endsWith("d")||a.endsWith("w")||a.endsWith("M")||a.endsWith("y")?r="1h":a.endsWith("h")&&parseInt(a)>=3?r="5m":a.endsWith("h")?r="1m":r="raw";const o=await L.getBulkClientBandwidthHistory(a,r),c={},S=u=>{if(u.length===0)return{rx:0,tx:0};const d=u.reduce((B,W)=>B+W.rx_bytes,0),U=u.reduce((B,W)=>B+W.tx_bytes,0);return{rx:d/(1024*1024),tx:U/(1024*1024)}};Object.keys(o).forEach(u=>{const d=S(o[u]?.data||[]);c[u]={dl_5m:d.rx,dl_30m:d.rx,dl_1h:d.rx,dl_1d:d.rx,ul_5m:d.tx,ul_30m:d.tx,ul_1h:d.tx,ul_1d:d.tx}}),K(c)}catch(r){console.error("Failed to fetch bandwidth averages:",r)}};s();const t=setInterval(s,6e4);return()=>clearInterval(t)},[i,h,m]);const w=s=>s.mac_address&&ce.includes(s.mac_address.toLowerCase())?!0:s.ip_address&&ie.includes(s.ip_address),Z=async s=>{if(!i)return;const t=w(s),a=t?"/api/devices/unblock":"/api/devices/block",r={mac_address:s.mac_address};s.ip_address&&s.ip_address.includes(".")&&(r.ip_address=s.ip_address),t?(k(o=>o.filter(c=>c!==s.ip_address)),T(o=>o.filter(c=>c!==s.mac_address.toLowerCase()))):r.ip_address&&(k(o=>Array.from(new Set([...o,r.ip_address]))),T(o=>Array.from(new Set([...o,s.mac_address.toLowerCase()]))));try{await fetch(a,{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify(r)})}catch{k(t?c=>Array.from(new Set([...c,s.ip_address])):c=>c.filter(S=>S!==s.ip_address))}},ee=async s=>{de(s),Y(!0),await E(s)},E=async s=>{if(i)try{const t=j==="custom"?x:j;if(!t||j==="custom"&&(!x||!v(x))){R([]);return}const a=await L.getClientBandwidthHistory(s.mac_address,t,F);R(a.data||[])}catch(t){console.error("Failed to load chart data:",t),R([])}};l.useEffect(()=>{if(z&&p){E(p);const s=setInterval(()=>E(p),H*1e3);return()=>clearInterval(s)}},[j,x,F,H,z,p,i]);const f=s=>s===0||!s?"0.00":s.toFixed(2),N=s=>s.nickname||s.hostname||"Unknown",D=s=>{const t=s.split(".");if(t.length===4){const a=t[3].padStart(3,"0");return`${t[0]}.${t[1]}.${t[2]}.${a}`}return s},b=s=>{M===s?Q(O==="asc"?"desc":"asc"):(je(s),Q(ve(s)?"desc":"asc"))},se=[...le].sort((s,t)=>{if(!M){const r=D(s.ip_address),o=D(t.ip_address);return r.localeCompare(o)}let a=0;switch(M){case"hostname":a=N(s).localeCompare(N(t));break;case"mac":a=s.mac_address.localeCompare(t.mac_address);break;case"ip":a=D(s.ip_address).localeCompare(D(t.ip_address));break;case"status":a=(s.is_online?0:1)-(t.is_online?0:1);break;case"dl":const r=s.mac_address.toLowerCase(),o=t.mac_address.toLowerCase(),c=g[r]?.dl_1h||0,S=g[o]?.dl_1h||0;a=c-S;break;case"ul":const u=s.mac_address.toLowerCase(),d=t.mac_address.toLowerCase(),U=g[u]?.ul_1h||0,B=g[d]?.ul_1h||0;a=U-B;break;default:return 0}return O==="asc"?a:-a}),y=s=>M!==s?null:O==="asc"?" ↑":" ↓",$=he.map(s=>({time:new Date(s.timestamp).toLocaleTimeString(),download:s.rx_mbps||0,upload:s.tx_mbps||0}));return e.jsxs("div",{className:"flex h-screen",children:[e.jsx(ke,{onLogout:be,isOpen:V,onClose:()=>X(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(we,{hostname:"nixos-router",username:ne,connectionStatus:fe,onMenuClick:()=>X(!V)}),e.jsxs("main",{className:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-900",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold mb-4 md:mb-6",children:"Device Usage"}),e.jsxs(ye,{children:[e.jsxs("div",{className:"mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300",children:"Interface Statistics"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:["br0","br1","ppp0"].map(s=>{const t=pe[s];return e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:s}),t?e.jsxs("div",{className:"text-gray-600 dark:text-gray-400 space-y-1 mt-1",children:[e.jsxs("div",{children:["DL: ",f(t.rx_mb)," MB"]}),e.jsxs("div",{children:["UL: ",f(t.tx_mb)," MB"]})]}):e.jsx("div",{className:"text-gray-400 dark:text-gray-500 mt-1",children:"No data"})]},s)})})]}),e.jsxs("div",{className:"mb-4 flex flex-wrap gap-4 items-end",children:[e.jsxs("div",{className:"min-w-[150px]",children:[e.jsx(C,{htmlFor:"table-range",value:"Time Period"}),e.jsxs(I,{id:"table-range",value:h,onChange:s=>{ge(s.target.value),s.target.value!=="custom"&&J("")},children:[e.jsx("option",{value:"1m",children:"1 minute"}),e.jsx("option",{value:"5m",children:"5 minutes"}),e.jsx("option",{value:"10m",children:"10 minutes"}),e.jsx("option",{value:"30m",children:"30 minutes"}),e.jsx("option",{value:"1h",children:"1 hour"}),e.jsx("option",{value:"3h",children:"3 hours"}),e.jsx("option",{value:"6h",children:"6 hours"}),e.jsx("option",{value:"12h",children:"12 hours"}),e.jsx("option",{value:"1d",children:"1 day"}),e.jsx("option",{value:"1w",children:"1 week"}),e.jsx("option",{value:"1M",children:"1 month"}),e.jsx("option",{value:"1y",children:"1 year"}),e.jsx("option",{value:"custom",children:"Custom"})]})]}),h==="custom"&&e.jsxs("div",{className:"min-w-[150px]",children:[e.jsx(C,{htmlFor:"table-custom",value:"Custom Range"}),e.jsx(ae,{id:"table-custom",placeholder:"e.g., 45m, 2h, 3d",value:m,onChange:s=>J(s.target.value),color:m&&!v(m)?"failure":void 0,helperText:m&&!v(m)?"Format: 1m, 5m, 1h, 1d, 1w, 1M, 1y":void 0})]})]}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs(n,{children:[e.jsxs(n.Head,{children:[e.jsxs(n.HeadCell,{className:"cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",onClick:()=>b("hostname"),children:["Hostname",y("hostname")]}),e.jsxs(n.HeadCell,{className:"cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",onClick:()=>b("mac"),children:["MAC",y("mac")]}),e.jsxs(n.HeadCell,{className:"cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",onClick:()=>b("ip"),children:["IP",y("ip")]}),e.jsxs(n.HeadCell,{className:"cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",onClick:()=>b("status"),children:["Status",y("status")]}),e.jsxs(n.HeadCell,{className:"cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",onClick:()=>b("dl"),children:["DL (MB)",y("dl")]}),e.jsxs(n.HeadCell,{className:"cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",onClick:()=>b("ul"),children:["UL (MB)",y("ul")]}),e.jsx(n.HeadCell,{children:"Chart"}),e.jsx(n.HeadCell,{children:"Details"}),e.jsx(n.HeadCell,{children:"Enable/Disable"})]}),e.jsx(n.Body,{className:"divide-y",children:se.map(s=>{const t=s.mac_address.toLowerCase(),a=g[t]||{dl_1h:0,ul_1h:0};return e.jsxs(n.Row,{className:s.is_online?"":"opacity-50",children:[e.jsx(n.Cell,{className:"font-medium",children:N(s)}),e.jsx(n.Cell,{className:"font-mono text-sm",children:s.mac_address}),e.jsx(n.Cell,{children:s.ip_address}),e.jsx(n.Cell,{children:e.jsx(te,{color:s.is_online?"success":"gray",size:"sm",children:s.is_online?"Online":"Offline"})}),e.jsxs(n.Cell,{className:"text-sm",children:[f(a.dl_1h)," MB"]}),e.jsxs(n.Cell,{className:"text-sm",children:[f(a.ul_1h)," MB"]}),e.jsx(n.Cell,{children:e.jsx(_,{size:"xs",color:"blue",onClick:()=>ee(s),children:"Chart"})}),e.jsx(n.Cell,{children:e.jsx(_,{size:"xs",color:"gray",onClick:()=>A(`/device-usage/${s.ip_address}`),children:"Details"})}),e.jsx(n.Cell,{children:e.jsx(_,{size:"xs",color:w(s)?"success":"failure",onClick:()=>Z(s),children:w(s)?"Enable":"Disable"})})]},s.mac_address)})})]})}),e.jsx("div",{className:"md:hidden space-y-3",children:se.map(s=>{const t=s.mac_address.toLowerCase(),a=g[t]||{dl_1h:0,ul_1h:0};return e.jsxs("div",{className:`p-4 rounded-lg border ${s.is_online?"bg-white border-gray-200 dark:bg-gray-800 dark:border-gray-700":"bg-gray-50 border-gray-200 dark:bg-gray-900 dark:border-gray-700 opacity-60"}`,children:[e.jsx("div",{className:"font-semibold text-lg mb-2",children:N(s)}),e.jsxs("div",{className:"text-sm space-y-1 mb-3",children:[e.jsxs("div",{children:["MAC: ",e.jsx("span",{className:"font-mono",children:s.mac_address})]}),e.jsxs("div",{children:["IP: ",s.ip_address]}),e.jsx(te,{color:s.is_online?"success":"gray",size:"sm",children:s.is_online?"Online":"Offline"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm mb-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Download"}),e.jsxs("div",{children:[f(a.dl_1h)," MB"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Upload"}),e.jsxs("div",{children:[f(a.ul_1h)," MB"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{size:"xs",color:"blue",onClick:()=>ee(s),className:"flex-1",children:"Chart"}),e.jsx(_,{size:"xs",color:"gray",onClick:()=>A(`/device-usage/${s.ip_address}`),className:"flex-1",children:"Details"}),e.jsx(_,{size:"xs",color:w(s)?"success":"failure",onClick:()=>Z(s),className:"flex-1",children:w(s)?"Enable":"Disable"})]})]},s.mac_address)})})]}),e.jsxs(P,{show:z,onClose:()=>Y(!1),size:"xl",children:[e.jsxs(P.Header,{children:["Bandwidth Usage - ",p?N(p):""]}),e.jsx(P.Body,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx(C,{htmlFor:"chart-range",value:"Time Range",className:"text-xs mb-1"}),e.jsxs(I,{id:"chart-range",sizing:"sm",value:j,onChange:s=>{me(s.target.value),s.target.value!=="custom"&&G("")},children:[e.jsx("option",{value:"1m",children:"1 minute"}),e.jsx("option",{value:"5m",children:"5 minutes"}),e.jsx("option",{value:"10m",children:"10 minutes"}),e.jsx("option",{value:"30m",children:"30 minutes"}),e.jsx("option",{value:"1h",children:"1 hour"}),e.jsx("option",{value:"3h",children:"3 hours"}),e.jsx("option",{value:"6h",children:"6 hours"}),e.jsx("option",{value:"12h",children:"12 hours"}),e.jsx("option",{value:"1d",children:"1 day"}),e.jsx("option",{value:"1w",children:"1 week"}),e.jsx("option",{value:"1M",children:"1 month"}),e.jsx("option",{value:"1y",children:"1 year"}),e.jsx("option",{value:"custom",children:"Custom"})]})]}),j==="custom"&&e.jsxs("div",{className:"min-w-[100px]",children:[e.jsx(C,{htmlFor:"chart-custom",value:"Custom",className:"text-xs mb-1"}),e.jsx(ae,{id:"chart-custom",sizing:"sm",placeholder:"e.g., 45m",value:x,onChange:s=>G(s.target.value),color:x&&!v(x)?"failure":void 0})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx(C,{htmlFor:"chart-interval",value:"Interval",className:"text-xs mb-1"}),e.jsxs(I,{id:"chart-interval",sizing:"sm",value:F,onChange:s=>xe(s.target.value),children:[e.jsx("option",{value:"raw",children:"Raw"}),e.jsx("option",{value:"1m",children:"1 minute"}),e.jsx("option",{value:"5m",children:"5 minutes"}),e.jsx("option",{value:"1h",children:"1 hour"})]})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx(C,{htmlFor:"chart-refresh",value:"Update Every",className:"text-xs mb-1"}),e.jsxs(I,{id:"chart-refresh",sizing:"sm",value:H,onChange:s=>ue(Number(s.target.value)),children:[e.jsx("option",{value:1,children:"1 second"}),e.jsx("option",{value:5,children:"5 seconds"}),e.jsx("option",{value:10,children:"10 seconds"}),e.jsx("option",{value:30,children:"30 seconds"}),e.jsx("option",{value:60,children:"1 minute"})]})]})]}),$.length>0?e.jsx(Ne,{width:"100%",height:300,children:e.jsxs(Se,{data:$,children:[e.jsx(Be,{strokeDasharray:"3 3"}),e.jsx(Me,{dataKey:"time",tick:{fontSize:12},interval:Math.floor($.length/8)}),e.jsx(De,{tick:{fontSize:12},label:{value:"Mbit/s",angle:-90,position:"insideLeft"}}),e.jsx(Ie,{}),e.jsx(Le,{}),e.jsx(re,{type:"monotone",dataKey:"download",stroke:"#3b82f6",name:"Download (Mbit/s)",strokeWidth:2,dot:!1,isAnimationActive:!1}),e.jsx(re,{type:"monotone",dataKey:"upload",stroke:"#10b981",name:"Upload (Mbit/s)",strokeWidth:2,dot:!1,isAnimationActive:!1})]})}):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No bandwidth data available for this time range."})]})})]})]})]})]})}export{Oe as DeviceUsage};
