import{j as e,C as P,L as b,S,p as q,B as U,u as _,f as $}from"./ui-vendor-B64yKeUt.js";import{u as W,a as t}from"./react-vendor-4URc7N9U.js";import{u as z,S as M,N as G}from"./useMetrics-CxenEB0U.js";import{a as v}from"./index-q3DjzbF8.js";import"./http-vendor-B9ygI19o.js";const J="",N=[{id:"system",label:"System Log"},{id:"dnsmasq-lan",label:"LAN DNS/DHCP"},{id:"dnsmasq-homelab",label:"HOMELAB DNS/DHCP"},{id:"nginx",label:"Nginx"},{id:"router-webui-backend",label:"WebUI Backend"},{id:"router-webui-celery-parallel",label:"Parallel Celery Worker"},{id:"router-webui-celery-sequential",label:"Sequential Celery Worker"},{id:"router-webui-celery-aggregation",label:"Aggregation Celery Worker"},{id:"postgresql",label:"Database"},{id:"sshd",label:"SSH"}],K=[100,200,500,1e3,2e3];function ee(){const o=localStorage.getItem("access_token"),k=localStorage.getItem("username")||"Unknown",C=W(),[L,p]=t.useState(!1),[l,R]=t.useState(N[0].id),[n,E]=t.useState(500),[a,w]=t.useState(!1),[m,x]=t.useState(""),[g,i]=t.useState(!1),[j,d]=t.useState(null),u=t.useRef(null),f=t.useRef(null),{connectionStatus:I}=z(o),h=t.useCallback(async s=>{if(!(!l||!o)){i(!0),d(null);try{const c=await v.getLogs(l,s);x(c)}catch(c){const r=c instanceof Error?c.message:"Failed to load logs";d(r),x("")}finally{i(!1)}}},[l,o]);t.useEffect(()=>{!a&&l&&h(n)},[l,n,a,h]),t.useEffect(()=>{if(!a||!l||!o)return;x(""),d(null),i(!0);const s=new AbortController;u.current=s;const c=`${J}/api/logs?service=${encodeURIComponent(l)}&lines=${n}&follow=true`;return(async()=>{try{const r=await fetch(c,{headers:{Authorization:`Bearer ${o}`},signal:s.signal});if(!r.ok||!r.body){d(`HTTP ${r.status}`),i(!1);return}i(!1);const O=r.body.getReader(),H=new TextDecoder;for(;;){const{done:T,value:B}=await O.read();if(T)break;x(D=>D+H.decode(B,{stream:!0}))}}catch(r){r.name!=="AbortError"&&d(r.message),i(!1)}finally{w(!1)}})(),()=>{s.abort(),u.current=null}},[a,l,n,o]),t.useEffect(()=>{f.current&&m&&(f.current.scrollTop=f.current.scrollHeight)},[m]);const A=async()=>{await v.logout(),C("/login")},y=s=>{!s&&u.current&&(u.current.abort(),u.current=null),w(s)},F=()=>{a&&y(!1),h(n)};return e.jsxs("div",{className:"flex h-screen",children:[e.jsx(M,{onLogout:A,isOpen:L,onClose:()=>p(!1)}),e.jsxs("div",{className:"flex flex-1 flex-col min-w-0",children:[e.jsx(G,{hostname:"nixos-router",username:k,connectionStatus:I,onMenuClick:()=>p(!0)}),e.jsx("main",{className:"flex-1 overflow-auto p-4",children:e.jsx("div",{className:"mx-auto max-w-full",children:e.jsxs(P,{children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Logs"}),e.jsxs("div",{className:"mb-4 flex flex-wrap items-end gap-4",children:[e.jsxs("div",{className:"min-w-[200px]",children:[e.jsx(b,{htmlFor:"log-source",className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Log to view"}),e.jsx(S,{id:"log-source",value:l,onChange:s=>R(s.target.value),disabled:a,children:N.map(s=>e.jsx("option",{value:s.id,children:s.label},s.id))})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx(b,{htmlFor:"lines",className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Lines to view"}),e.jsx(S,{id:"lines",value:n,onChange:s=>E(Number(s.target.value)),disabled:a,children:K.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{id:"follow",checked:a,onChange:s=>y(s.target.checked),disabled:g}),e.jsx(b,{htmlFor:"follow",className:"cursor-pointer text-sm text-gray-700 dark:text-gray-300",children:"Follow log (live tail, includes selected lines)"})]}),e.jsxs(U,{size:"sm",onClick:F,disabled:g||a,children:[e.jsx(_,{className:"mr-2 h-4 w-4"}),"Refresh"]})]}),j&&e.jsx("p",{className:"mb-2 text-sm text-red-600 dark:text-red-400",children:j}),g&&!m&&e.jsxs("div",{className:"flex items-center gap-2 py-4",children:[e.jsx($,{size:"sm"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:a?"Connecting...":"Loading logs..."})]}),e.jsx("pre",{ref:f,className:"max-h-[70vh] overflow-auto rounded bg-gray-900 p-3 text-xs text-gray-100 font-mono whitespace-pre-wrap break-words",children:m||(g?"":"Select a log and click Refresh or enable Follow.")})]})})})]})]})}export{ee as Logs};
