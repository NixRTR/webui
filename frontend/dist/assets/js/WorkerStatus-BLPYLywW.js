import{j as e,B as d,f as i,u as D,v as L,s as M,A as T,C as c,b as s,F as f,M as g}from"./ui-vendor-VTmJiFxm.js";import{u as O,a as t}from"./react-vendor-DIDCmA_u.js";import{u as P,S as q,N as Q}from"./useMetrics-CGyDbOB5.js";import{a as j}from"./index-B6_SmPvs.js";import"./http-vendor-B9ygI19o.js";function K(){const k=localStorage.getItem("access_token"),S=localStorage.getItem("username")||"Unknown",_=O(),[R,N]=t.useState(!1),[a,y]=t.useState(null),[m,b]=t.useState(!0),[p,o]=t.useState(null),[w,z]=t.useState(null),[E,u]=t.useState(!1),[n,x]=t.useState(null),{connectionStatus:I}=P(k),h=t.useCallback(async()=>{if(k){o(null);try{const l=await j.getWorkerStatus();y(l)}catch(l){const r=l instanceof Error?l.message:"Failed to load worker status";o(r),y(null)}finally{b(!1)}}},[k]);t.useEffect(()=>{h()},[h]);const W=async()=>{await j.logout(),_("/login")},B=()=>{b(!0),h()},C=async l=>{x(l);try{await j.revokeTask(l,!0),await h()}catch(r){const v=r instanceof Error?r.message:"Failed to revoke task";o(v)}finally{x(null)}},F=async()=>{u(!1),x("purge");try{await j.purgeWorkerQueues(),await h()}catch(l){const r=l instanceof Error?l.message:"Failed to purge queues";o(r)}finally{x(null)}},A=async()=>{x("test-task");try{const l=await j.triggerWorkerTestTask();z(l.task_id),await h()}catch(l){const r=l instanceof Error?l.message:"Failed to trigger test task";o(r)}finally{x(null)}},H=(l,r)=>l!=null?`${Math.round(l)}s`:r!=null?`${Math.round(Date.now()/1e3-r)}s`:"—";return e.jsxs("div",{className:"flex min-h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx(q,{onLogout:W,isOpen:R,onClose:()=>N(!1)}),e.jsxs("div",{className:"flex flex-1 flex-col",children:[e.jsx(Q,{hostname:"nixos-router",username:S,connectionStatus:I,onMenuClick:()=>N(!0)}),e.jsxs("main",{className:"flex-1 p-4 md:p-6",children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"Worker Status"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(d,{color:"gray",onClick:B,disabled:m,children:[m?e.jsx(i,{size:"sm",className:"mr-2"}):e.jsx(D,{className:"mr-2 h-4 w-4"}),"Refresh"]}),e.jsxs(d,{color:"failure",onClick:()=>u(!0),disabled:m||n==="purge",children:[n==="purge"?e.jsx(i,{size:"sm",className:"mr-2"}):e.jsx(L,{className:"mr-2 h-4 w-4"}),"Flush queue"]}),e.jsxs(d,{color:"info",onClick:A,disabled:m||n==="test-task",children:[n==="test-task"?e.jsx(i,{size:"sm",className:"mr-2"}):e.jsx(M,{className:"mr-2 h-4 w-4"}),"Trigger test task"]})]})]}),w&&e.jsxs(T,{color:"info",className:"mb-4",children:["Last test task ID: ",e.jsx("code",{className:"rounded bg-gray-100 px-1 dark:bg-gray-700",children:w})]}),p&&e.jsx(T,{color:"failure",className:"mb-4",onDismiss:()=>o(null),children:p}),m&&!a?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(i,{size:"xl"})}):a?e.jsxs("div",{className:"space-y-6",children:[e.jsxs(c,{children:[e.jsx("h2",{className:"mb-3 text-lg font-semibold text-gray-900 dark:text-white",children:"Queues"}),e.jsxs(s,{children:[e.jsxs(s.Head,{children:[e.jsx(s.HeadCell,{children:"Queue"}),e.jsx(s.HeadCell,{children:"In broker"}),e.jsx(s.HeadCell,{children:"Reserved"}),e.jsx(s.HeadCell,{children:"Active"})]}),e.jsx(s.Body,{children:a.queues.map(l=>e.jsxs(s.Row,{children:[e.jsx(s.Cell,{className:"font-medium",children:l.name}),e.jsx(s.Cell,{children:l.broker_length}),e.jsx(s.Cell,{children:l.reserved_count}),e.jsx(s.Cell,{children:l.active_count})]},l.name))})]})]}),e.jsxs(c,{children:[e.jsx("h2",{className:"mb-3 text-lg font-semibold text-gray-900 dark:text-white",children:"Active tasks"}),a.active_tasks.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"None"}):e.jsxs(s,{children:[e.jsxs(s.Head,{children:[e.jsx(s.HeadCell,{children:"Task ID"}),e.jsx(s.HeadCell,{children:"Name"}),e.jsx(s.HeadCell,{children:"Worker"}),e.jsx(s.HeadCell,{children:"Runtime"}),e.jsx(s.HeadCell,{})]}),e.jsx(s.Body,{children:a.active_tasks.map(l=>e.jsxs(s.Row,{children:[e.jsx(s.Cell,{className:"font-mono text-xs",children:l.id}),e.jsx(s.Cell,{children:l.name}),e.jsx(s.Cell,{children:l.worker??"—"}),e.jsx(s.Cell,{children:H(l.runtime,l.time_started)}),e.jsx(s.Cell,{children:e.jsx(d,{size:"xs",color:"failure",onClick:()=>C(l.id),disabled:n===l.id,children:n===l.id?e.jsx(i,{size:"sm"}):e.jsx(f,{className:"h-4 w-4"})})})]},l.id))})]})]}),e.jsxs(c,{children:[e.jsx("h2",{className:"mb-3 text-lg font-semibold text-gray-900 dark:text-white",children:"Reserved (queued at workers)"}),a.reserved_tasks.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"None"}):e.jsxs(s,{children:[e.jsxs(s.Head,{children:[e.jsx(s.HeadCell,{children:"Task ID"}),e.jsx(s.HeadCell,{children:"Name"}),e.jsx(s.HeadCell,{children:"Worker"}),e.jsx(s.HeadCell,{})]}),e.jsx(s.Body,{children:a.reserved_tasks.map(l=>e.jsxs(s.Row,{children:[e.jsx(s.Cell,{className:"font-mono text-xs",children:l.id}),e.jsx(s.Cell,{children:l.name}),e.jsx(s.Cell,{children:l.worker??"—"}),e.jsx(s.Cell,{children:e.jsx(d,{size:"xs",color:"failure",onClick:()=>C(l.id),disabled:n===l.id,children:n===l.id?e.jsx(i,{size:"sm"}):e.jsx(f,{className:"h-4 w-4"})})})]},l.id))})]})]}),e.jsxs(c,{children:[e.jsx("h2",{className:"mb-3 text-lg font-semibold text-gray-900 dark:text-white",children:"Scheduled (ETA)"}),a.scheduled_tasks.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"None"}):e.jsxs(s,{children:[e.jsxs(s.Head,{children:[e.jsx(s.HeadCell,{children:"Task ID"}),e.jsx(s.HeadCell,{children:"Name"}),e.jsx(s.HeadCell,{children:"Worker"}),e.jsx(s.HeadCell,{children:"ETA"})]}),e.jsx(s.Body,{children:a.scheduled_tasks.map(l=>e.jsxs(s.Row,{children:[e.jsx(s.Cell,{className:"font-mono text-xs",children:l.id}),e.jsx(s.Cell,{children:l.name}),e.jsx(s.Cell,{children:l.worker??"—"}),e.jsx(s.Cell,{children:l.eta??"—"})]},l.id))})]})]}),e.jsxs(c,{className:"border-amber-200 dark:border-amber-800",children:[e.jsx("h2",{className:"mb-3 text-lg font-semibold text-amber-700 dark:text-amber-400",children:"Overdue"}),a.overdue_tasks.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"None"}):e.jsxs(s,{children:[e.jsxs(s.Head,{children:[e.jsx(s.HeadCell,{children:"Task ID"}),e.jsx(s.HeadCell,{children:"Name"}),e.jsx(s.HeadCell,{children:"Worker"}),e.jsx(s.HeadCell,{children:"ETA"})]}),e.jsx(s.Body,{children:a.overdue_tasks.map(l=>e.jsxs(s.Row,{children:[e.jsx(s.Cell,{className:"font-mono text-xs",children:l.id}),e.jsx(s.Cell,{children:l.name}),e.jsx(s.Cell,{children:l.worker??"—"}),e.jsx(s.Cell,{children:l.eta??"—"})]},l.id))})]})]}),e.jsxs(c,{className:"border-orange-200 dark:border-orange-800",children:[e.jsx("h2",{className:"mb-3 text-lg font-semibold text-orange-700 dark:text-orange-400",children:"Long-running"}),a.long_running_tasks.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"None"}):e.jsxs(s,{children:[e.jsxs(s.Head,{children:[e.jsx(s.HeadCell,{children:"Task ID"}),e.jsx(s.HeadCell,{children:"Name"}),e.jsx(s.HeadCell,{children:"Worker"}),e.jsx(s.HeadCell,{children:"Runtime"}),e.jsx(s.HeadCell,{})]}),e.jsx(s.Body,{children:a.long_running_tasks.map(l=>e.jsxs(s.Row,{children:[e.jsx(s.Cell,{className:"font-mono text-xs",children:l.id}),e.jsx(s.Cell,{children:l.name}),e.jsx(s.Cell,{children:l.worker??"—"}),e.jsx(s.Cell,{children:H(l.runtime,l.time_started)}),e.jsx(s.Cell,{children:e.jsx(d,{size:"xs",color:"failure",onClick:()=>C(l.id),disabled:n===l.id,children:n===l.id?e.jsx(i,{size:"sm"}):e.jsx(f,{className:"h-4 w-4"})})})]},l.id))})]})]})]}):e.jsx(c,{className:"p-6",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"No worker data available. Check that Celery workers are running and Redis is reachable."})})]})]}),e.jsxs(g,{show:E,onClose:()=>u(!1),size:"md",children:[e.jsx(g.Header,{children:"Flush task queues"}),e.jsx(g.Body,{children:e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Permanently remove all messages from task queues (celery, sequential, parallel). This cannot be undone."})}),e.jsxs(g.Footer,{children:[e.jsx(d,{color:"gray",onClick:()=>u(!1),children:"Cancel"}),e.jsx(d,{color:"failure",onClick:F,children:"Flush"})]})]})]})}export{K as WorkerStatus};
