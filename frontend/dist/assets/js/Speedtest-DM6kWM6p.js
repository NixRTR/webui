import{j as e,B as y,C as _,e as Y,f as Z,P as q,S as R,L as J,T as Q,b as o}from"./ui-vendor-k77EgL80.js";import{u as V,r as n}from"./react-vendor-DKKOAuGG.js";import{C as W}from"./CustomTooltip-DM8zZGfr.js";import{u as ee,S as te,N as se}from"./useMetrics-SMOI0hlC.js";import{a as ae}from"./index-DX623gsV.js";import{R as re,L as ne,C as ie,X as oe,Y as le,T as ce,a as de,b as P}from"./charts-_iF2RbR3.js";import"./http-vendor-B9ygI19o.js";const ue=[{value:1,label:"1 hour"},{value:3,label:"3 hours"},{value:6,label:"6 hours"},{value:12,label:"12 hours"},{value:24,label:"1 day"},{value:168,label:"1 week"},{value:336,label:"2 weeks"},{value:720,label:"1 month"},{value:2160,label:"3 months"},{value:4320,label:"6 months"},{value:8760,label:"1 year"}],me=[10,25,50,100];function we(){const a=localStorage.getItem("access_token"),L=localStorage.getItem("username")||"Unknown",A=V(),[N,C]=n.useState(!1),{connectionStatus:O}=ee(a),[u,B]=n.useState(24),[F,k]=n.useState([]),[c,f]=n.useState(1),[h,$]=n.useState(25),[z,v]=n.useState(""),[H,S]=n.useState(!1),[p,T]=n.useState(null),[s,D]=n.useState({is_running:!1}),[m,I]=n.useState(null),g=n.useRef(null),M=async()=>{await ae.logout(),A("/login")};n.useEffect(()=>{const t=async()=>{if(a)try{const l=await fetch(`/api/speedtest/chart-data?hours=${u}`,{headers:{Authorization:`Bearer ${a}`}});if(l.ok){const d=await l.json();k(d.data||[])}}catch(l){console.error("Error fetching chart data:",l)}};t();const r=setInterval(t,3e4);return()=>clearInterval(r)},[a,u]),n.useEffect(()=>{(async()=>{if(a)try{const r=new Date,l=new Date(r.getTime()-u*60*60*1e3),d=await fetch(`/api/speedtest/history?start_time=${l.toISOString()}&end_time=${r.toISOString()}&page=${c}&page_size=${h}`,{headers:{Authorization:`Bearer ${a}`}});if(d.ok){const x=await d.json();T(x)}}catch(r){console.error("Error fetching table data:",r)}})()},[a,u,c,h]),n.useEffect(()=>{(async()=>{if(a)try{const r=new Date,l=new Date(r.getTime()-720*60*60*1e3),d=await fetch(`/api/speedtest/history?start_time=${l.toISOString()}&end_time=${r.toISOString()}&page=1&page_size=1`,{headers:{Authorization:`Bearer ${a}`}});if(d.ok){const x=await d.json();x.results&&x.results.length>0&&I(x.results[0])}}catch(r){console.error("Error fetching last speedtest result:",r)}})()},[a]),n.useEffect(()=>{if(s.is_running){const t=async()=>{try{const r=await fetch("/api/speedtest/status",{headers:{Authorization:`Bearer ${a}`}});if(r.ok){const l=await r.json();if(D(l),!l.is_running&&s.is_running){const d=async()=>{try{const i=await fetch(`/api/speedtest/chart-data?hours=${u}`,{headers:{Authorization:`Bearer ${a}`}});if(i.ok){const j=await i.json();k(j.data||[])}}catch(i){console.error("Error fetching chart data:",i)}},x=async()=>{try{const i=new Date,j=new Date(i.getTime()-u*60*60*1e3),b=await fetch(`/api/speedtest/history?start_time=${j.toISOString()}&end_time=${i.toISOString()}&page=${c}&page_size=${h}`,{headers:{Authorization:`Bearer ${a}`}});if(b.ok){const w=await b.json();T(w)}}catch(i){console.error("Error fetching table data:",i)}},X=async()=>{try{const i=new Date,j=new Date(i.getTime()-720*60*60*1e3),b=await fetch(`/api/speedtest/history?start_time=${j.toISOString()}&end_time=${i.toISOString()}&page=1&page_size=1`,{headers:{Authorization:`Bearer ${a}`}});if(b.ok){const w=await b.json();w.results&&w.results.length>0&&I(w.results[0])}}catch(i){console.error("Error fetching last result:",i)}};d(),x(),X()}}}catch(r){console.error("Error polling status:",r)}};return g.current=window.setInterval(t,1e3),()=>{g.current&&clearInterval(g.current)}}else g.current&&(clearInterval(g.current),g.current=null)},[s.is_running,a,u,c,h]);const U=async()=>{if(a)try{(await fetch("/api/speedtest/trigger",{method:"POST",headers:{Authorization:`Bearer ${a}`}})).ok&&D({is_running:!0,progress:0})}catch(t){console.error("Error triggering speedtest:",t)}},K=t=>{t==="custom"?S(!0):($(parseInt(t)),f(1),S(!1),v(""))},E=()=>{const t=parseInt(z);t>=1&&t<=200&&($(t),f(1),S(!1),v(""))},G=t=>new Date(t).toLocaleString();return e.jsxs("div",{className:"flex h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx(te,{isOpen:N,onClose:()=>C(!1),onLogout:M}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(se,{hostname:"nixos-router",username:L,connectionStatus:O,onMenuClick:()=>C(!N)}),e.jsx("main",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Speedtest"}),e.jsx(y,{onClick:U,disabled:s.is_running,color:"blue",children:s.is_running?"Running...":"Run Speedtest"})]}),e.jsx(_,{children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:s.is_running?"Speedtest in Progress":"Last Speedtest Result"}),m&&e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-6",children:new Date(m.timestamp).toLocaleString()}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-8 mb-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Download"}),e.jsx(Y,{className:`w-5 h-5 text-blue-600 dark:text-blue-400 ${s.is_running&&s.current_phase==="download"?"animate-pulse drop-shadow-lg":""}`,style:s.is_running&&s.current_phase==="download"?{filter:"drop-shadow(0 0 8px rgba(59, 130, 246, 0.8))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{}})]}),e.jsx("div",{className:`text-5xl font-bold text-blue-600 dark:text-blue-400 ${s.is_running&&s.current_phase==="download"?"drop-shadow-lg":""}`,style:s.is_running&&s.current_phase==="download"?{filter:"drop-shadow(0 0 12px rgba(59, 130, 246, 0.6))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{},children:s.is_running&&s.download_mbps?`${s.download_mbps.toFixed(2)}`:m?`${m.download_mbps.toFixed(2)}`:"--"}),e.jsx("div",{className:"text-lg text-gray-500 dark:text-gray-400 mt-1",children:"Mbps"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Upload"}),e.jsx(Z,{className:`w-5 h-5 text-green-600 dark:text-green-400 ${s.is_running&&s.current_phase==="upload"?"animate-pulse drop-shadow-lg":""}`,style:s.is_running&&s.current_phase==="upload"?{filter:"drop-shadow(0 0 8px rgba(16, 185, 129, 0.8))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{}})]}),e.jsx("div",{className:`text-5xl font-bold text-green-600 dark:text-green-400 ${s.is_running&&s.current_phase==="upload"?"drop-shadow-lg":""}`,style:s.is_running&&s.current_phase==="upload"?{filter:"drop-shadow(0 0 12px rgba(16, 185, 129, 0.6))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{},children:s.is_running&&s.upload_mbps?`${s.upload_mbps.toFixed(2)}`:m?`${m.upload_mbps.toFixed(2)}`:"--"}),e.jsx("div",{className:"text-lg text-gray-500 dark:text-gray-400 mt-1",children:"Mbps"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600 dark:text-gray-400 mb-2",children:"Ping"}),e.jsx("div",{className:"text-5xl font-bold text-gray-700 dark:text-gray-300",children:s.is_running&&s.ping_ms?`${s.ping_ms.toFixed(2)}`:m?`${m.ping_ms.toFixed(2)}`:"--"}),e.jsx("div",{className:"text-lg text-gray-500 dark:text-gray-400 mt-1",children:"ms"})]})]}),s.is_running&&s.progress!==void 0&&e.jsxs("div",{className:"mt-4",children:[e.jsx(q,{progress:s.progress,color:"blue"}),e.jsx("div",{className:"text-sm text-gray-500 mt-2 text-center",children:s.current_phase||"Starting..."})]})]})}),e.jsxs(_,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"Speedtest Results"}),e.jsx(R,{value:u,onChange:t=>{B(parseInt(t.target.value)),f(1)},className:"w-48",children:ue.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsx(re,{width:"100%",height:400,children:e.jsxs(ne,{data:F,children:[e.jsx(ie,{strokeDasharray:"3 3"}),e.jsx(oe,{dataKey:"timestamp",tickFormatter:t=>new Date(t).toLocaleTimeString()}),e.jsx(le,{label:{value:"Mbps",angle:-90,position:"insideLeft"}}),e.jsx(ce,{content:e.jsx(W,{})}),e.jsx(de,{}),e.jsx(P,{type:"monotone",dataKey:"download_mbps",stroke:"#3b82f6",name:"Download",dot:!1}),e.jsx(P,{type:"monotone",dataKey:"upload_mbps",stroke:"#10b981",name:"Upload",dot:!1})]})})]}),e.jsxs(_,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"Test History"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{htmlFor:"page-size",children:"Results per page:"}),H?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{id:"custom-page-size",type:"number",min:"1",max:"200",value:z,onChange:t=>v(t.target.value),onKeyPress:t=>{t.key==="Enter"&&E()},className:"w-20"}),e.jsx(y,{size:"sm",onClick:E,children:"Apply"}),e.jsx(y,{size:"sm",color:"gray",onClick:()=>{S(!1),v("")},children:"Cancel"})]}):e.jsxs(R,{id:"page-size",value:h.toString(),onChange:t=>K(t.target.value),className:"w-32",children:[me.map(t=>e.jsx("option",{value:t.toString(),children:t},t)),e.jsx("option",{value:"custom",children:"Custom"})]})]})]}),e.jsxs(o,{children:[e.jsxs(o.Head,{children:[e.jsx(o.HeadCell,{children:"Timestamp"}),e.jsx(o.HeadCell,{children:"Download (Mbps)"}),e.jsx(o.HeadCell,{children:"Upload (Mbps)"}),e.jsx(o.HeadCell,{children:"Ping (ms)"}),e.jsx(o.HeadCell,{children:"Server"})]}),e.jsx(o.Body,{className:"divide-y",children:p?.results.map(t=>e.jsxs(o.Row,{children:[e.jsx(o.Cell,{children:G(t.timestamp)}),e.jsx(o.Cell,{children:t.download_mbps.toFixed(2)}),e.jsx(o.Cell,{children:t.upload_mbps.toFixed(2)}),e.jsx(o.Cell,{children:t.ping_ms.toFixed(2)}),e.jsx(o.Cell,{children:t.server_name||"-"})]},t.id))})]}),p&&p.total_pages>1&&e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["Showing ",(c-1)*h+1," to ",Math.min(c*h,p.total)," of ",p.total," results"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{size:"sm",color:"gray",disabled:c===1,onClick:()=>f(c-1),children:"Previous"}),e.jsx(y,{size:"sm",color:"gray",disabled:c===p.total_pages,onClick:()=>f(c+1),children:"Next"})]})]})]})]})})]})]})}export{we as Speedtest};
