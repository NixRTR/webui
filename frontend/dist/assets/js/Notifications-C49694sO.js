import{j as e,o as de,B as d,A as v,C as f,b as n,a as N,M as h,L as l,T as g,p as me,S as E,q as he,n as xe}from"./ui-vendor-spcouQ_w.js";import{u as pe,r as i}from"./react-vendor-DKKOAuGG.js";import{u as ue,S as ge,N as je}from"./useMetrics-DVnqeG2I.js";import{a as r}from"./index-BWgEZrch.js";import"./http-vendor-B9ygI19o.js";const H="{{ parameter_name }} is {{ current_value }} ({{ current_level | upper }})",D={name:"",enabled:!0,parameter_type:"",parameter_config:{},threshold_info:"",threshold_warning:"",threshold_failure:"",comparison_operator:"gt",duration_seconds:60,cooldown_seconds:300,apprise_service_indices:[],message_template:H};function be(){const G=localStorage.getItem("access_token"),V=localStorage.getItem("username")||"Unknown",{connectionStatus:J}=ue(G),K=pe(),[A,O]=i.useState([]),[y,Q]=i.useState([]),[L,X]=i.useState([]),[Y,P]=i.useState(!0),[M,b]=i.useState(null),[Z,C]=i.useState(!1),[_,w]=i.useState({open:!1,items:[],ruleName:""}),[z,U]=i.useState(!1),[t,x]=i.useState(D),[$,p]=i.useState(null),[B,u]=i.useState(null),[I,m]=i.useState(null);i.useEffect(()=>{(async()=>{try{P(!0);const[a,c,F]=await Promise.all([r.getNotificationRules(),r.getNotificationParameters(),r.getAppriseServices()]);O(a),Q(c),X(F)}catch(a){b(a?.response?.data?.detail||a.message||"Failed to load notifications")}finally{P(!1)}})()},[]);const j=i.useMemo(()=>y.find(s=>s.type===t.parameter_type),[y,t.parameter_type]),ee=()=>{x(D),p(null),u(null),m(null),C(!0)},se=async()=>{await r.logout(),K("/login")},ae=s=>{x({id:s.id,name:s.name,enabled:s.enabled,parameter_type:s.parameter_type,parameter_config:Object.fromEntries(Object.entries(s.parameter_config||{}).map(([a,c])=>[a,String(c??"")])),threshold_info:s.threshold_info!==null&&s.threshold_info!==void 0?String(s.threshold_info):"",threshold_warning:s.threshold_warning!==null&&s.threshold_warning!==void 0?String(s.threshold_warning):"",threshold_failure:s.threshold_failure!==null&&s.threshold_failure!==void 0?String(s.threshold_failure):"",comparison_operator:s.comparison_operator,duration_seconds:s.duration_seconds,cooldown_seconds:s.cooldown_seconds,apprise_service_indices:[...s.apprise_service_indices||[]],message_template:s.message_template||H}),p(null),u(null),m(null),C(!0)},S=()=>{C(!1),x(D),p(null),u(null),m(null)},o=(s,a)=>{x(c=>({...c,[s]:a}))},q=(s,a)=>{x(c=>({...c,parameter_config:{...c.parameter_config,[s]:a}}))},te=s=>{x(a=>{const F=a.apprise_service_indices.includes(s)?a.apprise_service_indices.filter(R=>R!==s):[...a.apprise_service_indices,s].sort((R,ce)=>R-ce);return{...a,apprise_service_indices:F}})},T=s=>{if(s===""||s===null||s===void 0)return;const a=Number(s);return Number.isNaN(a)?void 0:a},k=async()=>{const s=await r.getNotificationRules();O(s)},ne=async()=>{if(p(null),u(null),!t.parameter_type){p("Please select a parameter to monitor.");return}const s={name:t.name,enabled:t.enabled,parameter_type:t.parameter_type,parameter_config:t.parameter_config,threshold_info:T(t.threshold_info),threshold_warning:T(t.threshold_warning),threshold_failure:T(t.threshold_failure),comparison_operator:t.comparison_operator,duration_seconds:t.duration_seconds,cooldown_seconds:t.cooldown_seconds,apprise_service_indices:t.apprise_service_indices,message_template:t.message_template||H};try{t.id?(await r.updateNotificationRule(t.id,s),u("Notification rule updated.")):(await r.createNotificationRule(s),u("Notification rule created.")),await k(),setTimeout(S,600)}catch(a){p(a?.response?.data?.detail||a.message||"Failed to save notification rule")}},ie=async s=>{await r.updateNotificationRule(s.id,{enabled:!s.enabled}),await k()},le=async s=>{window.confirm(`Delete notification "${s.name}"? This cannot be undone.`)&&(await r.deleteNotificationRule(s.id),await k())},re=async s=>{m(null);try{const a=await r.testNotificationRule(s.id);a.success?m(`Test sent (${a.level.toUpperCase()}): ${a.message}`):m(a.error||"Test failed to send")}catch(a){m(a?.response?.data?.detail||a.message||"Test failed")}},oe=async s=>{try{const a=await r.getNotificationHistory(s.id);w({open:!0,items:a.items,ruleName:s.name})}catch(a){b(a?.response?.data?.detail||a.message||"Failed to load history")}},W=s=>s?new Date(s).toLocaleString():"—";return Y?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(de,{size:"xl"})}):e.jsxs("div",{className:"flex h-screen",children:[e.jsx(ge,{onLogout:se,isOpen:z,onClose:()=>U(!1)}),e.jsxs("div",{className:"flex flex-1 flex-col overflow-hidden",children:[e.jsx(je,{hostname:"nixos-router",username:V,connectionStatus:J,onMenuClick:()=>U(!z)}),e.jsxs("main",{className:"flex-1 overflow-y-auto bg-gray-50 p-6 dark:bg-gray-900",children:[e.jsxs("div",{className:"mx-auto flex max-w-7xl items-center justify-between pb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Notifications"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Automatically send Apprise notifications when monitored metrics cross thresholds."})]}),e.jsx(d,{onClick:ee,children:"New Rule"})]}),M&&e.jsx(v,{color:"failure",className:"mb-4",onDismiss:()=>b(null),children:M}),e.jsxs(f,{className:"mb-6",children:[e.jsx("div",{className:"mb-4 flex items-center justify-between",children:e.jsx("h2",{className:"text-xl font-semibold",children:"Configured Rules"})}),A.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No notifications configured yet. Click “New Rule” to begin."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(n,{children:[e.jsxs(n.Head,{children:[e.jsx(n.HeadCell,{children:"Name"}),e.jsx(n.HeadCell,{children:"Parameter"}),e.jsx(n.HeadCell,{children:"Thresholds"}),e.jsx(n.HeadCell,{children:"Status"}),e.jsx(n.HeadCell,{children:"Last Notification"}),e.jsx(n.HeadCell,{children:"Actions"})]}),e.jsx(n.Body,{className:"divide-y",children:A.map(s=>e.jsxs(n.Row,{className:"bg-white dark:border-gray-700 dark:bg-gray-800",children:[e.jsxs(n.Cell,{children:[e.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:s.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:["#",s.id]})]}),e.jsxs(n.Cell,{children:[e.jsx("div",{className:"text-sm font-medium",children:s.parameter_type}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Duration ",s.duration_seconds,"s · Cooldown ",s.cooldown_seconds,"s"]})]}),e.jsx(n.Cell,{children:e.jsxs("div",{className:"text-xs text-gray-500",children:[e.jsx("span",{className:"font-semibold",children:"Info:"})," ",s.threshold_info??"—"," · ",e.jsx("span",{className:"font-semibold",children:"Warn:"})," ",s.threshold_warning??"—"," · ",e.jsx("span",{className:"font-semibold",children:"Fail:"})," ",s.threshold_failure??"—"]})}),e.jsx(n.Cell,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{color:s.enabled?"success":"gray",children:s.enabled?"Enabled":"Disabled"}),s.current_level&&e.jsx(N,{color:s.current_level==="failure"?"failure":"warning",children:s.current_level.toUpperCase()})]})}),e.jsxs(n.Cell,{children:[e.jsx("div",{className:"text-xs text-gray-500",children:W(s.last_notification_at)}),e.jsx("div",{className:"text-xs text-gray-400",children:s.last_notification_level??""})]}),e.jsx(n.Cell,{children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(d,{size:"xs",onClick:()=>ae(s),children:"Edit"}),e.jsx(d,{size:"xs",color:"light",onClick:()=>ie(s),children:s.enabled?"Disable":"Enable"}),e.jsx(d,{size:"xs",color:"purple",onClick:()=>re(s),children:"Test"}),e.jsx(d,{size:"xs",color:"info",onClick:()=>oe(s),children:"History"}),e.jsx(d,{size:"xs",color:"failure",onClick:()=>le(s),children:"Delete"})]})})]},s.id))})]})})]})]})]}),e.jsxs(h,{show:Z,size:"4xl",onClose:S,children:[e.jsx(h.Header,{children:t.id?"Edit Notification Rule":"Create Notification Rule"}),e.jsx(h.Body,{children:e.jsxs("div",{className:"space-y-4",children:[$&&e.jsx(v,{color:"failure",onDismiss:()=>p(null),children:$}),B&&e.jsx(v,{color:"success",onDismiss:()=>u(null),children:B}),I&&e.jsx(v,{color:"info",onDismiss:()=>m(null),children:I}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(l,{htmlFor:"name",value:"Name"}),e.jsx(g,{id:"name",value:t.name,onChange:s=>o("name",s.target.value),placeholder:"CPU usage alerts"})]}),e.jsxs("div",{className:"flex items-end justify-between",children:[e.jsxs("div",{children:[e.jsx(l,{value:"Enabled"}),e.jsx(me,{checked:t.enabled,onChange:s=>o("enabled",s)})]}),e.jsxs("div",{children:[e.jsx(l,{value:"Comparison"}),e.jsxs(E,{value:t.comparison_operator,onChange:s=>o("comparison_operator",s.target.value),children:[e.jsx("option",{value:"gt",children:"Greater than (>=)"}),e.jsx("option",{value:"lt",children:"Less than (<=)"})]})]})]})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:"parameter",value:"Parameter"}),e.jsxs(E,{id:"parameter",value:t.parameter_type,onChange:s=>x(a=>({...a,parameter_type:s.target.value,parameter_config:{}})),children:[e.jsx("option",{value:"",children:"Select parameter"}),y.map(s=>e.jsx("option",{value:s.type,children:s.label},s.type))]}),j?.description&&e.jsx("p",{className:"text-xs text-gray-500",children:j.description})]}),j?.requires_config&&e.jsxs(f,{children:[e.jsx("h3",{className:"mb-2 text-sm font-semibold",children:"Parameter Settings"}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:j.config_fields.map(s=>e.jsxs("div",{children:[e.jsx(l,{htmlFor:`config-${s.name}`,value:s.label}),s.field_type==="select"&&s.options?e.jsxs(E,{id:`config-${s.name}`,value:t.parameter_config[s.name]||"",onChange:a=>q(s.name,a.target.value),children:[e.jsx("option",{value:"",children:"Select..."}),s.options.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]}):e.jsx(g,{id:`config-${s.name}`,value:t.parameter_config[s.name]||"",onChange:a=>q(s.name,a.target.value),placeholder:s.description}),s.description&&e.jsx("p",{className:"text-xs text-gray-500",children:s.description})]},s.name))})]}),e.jsxs(f,{children:[e.jsx("h3",{className:"mb-2 text-sm font-semibold",children:"Thresholds"}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx(l,{value:"Info threshold"}),e.jsx(g,{value:t.threshold_info,onChange:s=>o("threshold_info",s.target.value),placeholder:"Optional"})]}),e.jsxs("div",{children:[e.jsx(l,{value:"Warning threshold"}),e.jsx(g,{value:t.threshold_warning,onChange:s=>o("threshold_warning",s.target.value),placeholder:"Optional"})]}),e.jsxs("div",{children:[e.jsx(l,{value:"Failure threshold"}),e.jsx(g,{value:t.threshold_failure,onChange:s=>o("threshold_failure",s.target.value),placeholder:"Optional"})]})]}),e.jsxs("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(l,{value:"Duration (seconds)"}),e.jsx(g,{type:"number",min:5,value:t.duration_seconds,onChange:s=>o("duration_seconds",Number(s.target.value))})]}),e.jsxs("div",{children:[e.jsx(l,{value:"Cooldown (seconds)"}),e.jsx(g,{type:"number",min:0,value:t.cooldown_seconds,onChange:s=>o("cooldown_seconds",Number(s.target.value))})]})]})]}),e.jsxs(f,{children:[e.jsx("h3",{className:"mb-2 text-sm font-semibold",children:"Apprise Services"}),L.length===0?e.jsx("p",{className:"text-xs text-gray-500",children:"No Apprise services configured."}):e.jsx("div",{className:"grid gap-2 md:grid-cols-2",children:L.map((s,a)=>e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-200",children:[e.jsx(he,{checked:t.apprise_service_indices.includes(a),onChange:()=>te(a)}),e.jsxs("span",{children:[e.jsx("span",{className:"font-semibold",children:s.description||`Service ${a+1}`}),e.jsx("span",{className:"ml-2 text-xs text-gray-500",children:s.url})]})]},a))})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:"messageTemplate",value:"Message Template"}),e.jsx(xe,{id:"messageTemplate",rows:4,value:t.message_template,onChange:s=>o("message_template",s.target.value)}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:["Available variables:"," ",(j?.variables||[]).map(s=>e.jsx(N,{color:"info",className:"mr-1",children:s},s))]})]})]})}),e.jsxs(h.Footer,{children:[e.jsx(d,{onClick:ne,children:t.id?"Save Changes":"Create Rule"}),e.jsx(d,{color:"light",onClick:S,children:"Cancel"})]})]}),e.jsxs(h,{show:_.open,onClose:()=>w({open:!1,items:[],ruleName:""}),children:[e.jsxs(h.Header,{children:["Notification History · ",_.ruleName]}),e.jsx(h.Body,{children:_.items.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No history recorded."}):e.jsx("div",{className:"space-y-3",children:_.items.map(s=>e.jsxs(f,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:W(s.timestamp)}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Value: ",s.value]})]}),e.jsx(N,{color:s.sent_successfully?"success":"failure",children:s.level.toUpperCase()})]}),s.message&&e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:s.message})]},s.id))})}),e.jsx(h.Footer,{children:e.jsx(d,{color:"light",onClick:()=>w({open:!1,items:[],ruleName:""}),children:"Close"})})]})]})}export{be as Notifications};
