import{j as s,C as W,L as p,S as w,r as $,B as z,w as M,h as V}from"./ui-vendor-XgbUf-17.js";import{u as G,j as J,a}from"./react-vendor-DIDCmA_u.js";import{u as K,S as Q,N as X}from"./useMetrics-Ci0MPOhy.js";import{a as E}from"./index-TxezpQ-Z.js";import"./http-vendor-B9ygI19o.js";const Y="",S=[{id:"system",label:"System Log"},{id:"dnsmasq-lan",label:"LAN DNS/DHCP"},{id:"dnsmasq-homelab",label:"HOMELAB DNS/DHCP"},{id:"nginx",label:"Nginx"},{id:"router-webui-backend",label:"WebUI Backend"},{id:"router-webui-celery-parallel",label:"Parallel Celery Worker"},{id:"router-webui-celery-sequential",label:"Sequential Celery Worker"},{id:"router-webui-celery-aggregation",label:"Aggregation Celery Worker"},{id:"postgresql",label:"Database"},{id:"redis",label:"REDIS"},{id:"sshd",label:"SSH"}],Z=[100,200,500,1e3,2e3],ee=[{value:"all",label:"All"},{value:"err",label:"Error"},{value:"warning",label:"Warning"},{value:"info",label:"Info"},{value:"debug",label:"Debug"}],se=new Set(S.map(n=>n.id));function ne(){const n=localStorage.getItem("access_token"),R=localStorage.getItem("username")||"Unknown",I=G(),[j]=J(),[O,y]=a.useState(!1),[r,N]=a.useState(S[0].id);a.useEffect(()=>{const e=j.get("service");e&&se.has(e)&&N(e)},[j]);const[i,P]=a.useState(500),[t,A]=a.useState("all"),[l,k]=a.useState(!1),[x,g]=a.useState(""),[f,c]=a.useState(!1),[L,u]=a.useState(null),m=a.useRef(null),h=a.useRef(null),{connectionStatus:D}=K(n),v=a.useCallback(async(e,b=t)=>{if(!(!r||!n)){c(!0),u(null);try{const d=await E.getLogs(r,e,b);g(d)}catch(d){const o=d instanceof Error?d.message:"Failed to load logs";u(o),g("")}finally{c(!1)}}},[r,n,t]);a.useEffect(()=>{!l&&r&&v(i,t)},[r,i,t,l,v]),a.useEffect(()=>{if(!l||!r||!n)return;g(""),u(null),c(!0);const e=new AbortController;m.current=e;const b=new URLSearchParams({service:r,lines:String(i),follow:"true"});t&&t!=="all"&&b.set("priority",t);const d=`${Y}/api/logs?${b.toString()}`;return(async()=>{try{const o=await fetch(d,{headers:{Authorization:`Bearer ${n}`},signal:e.signal});if(!o.ok||!o.body){u(`HTTP ${o.status}`),c(!1);return}c(!1);const T=o.body.getReader(),H=new TextDecoder;for(;;){const{done:B,value:U}=await T.read();if(B)break;g(q=>q+H.decode(U,{stream:!0}))}}catch(o){o.name!=="AbortError"&&u(o.message),c(!1)}finally{k(!1)}})(),()=>{e.abort(),m.current=null}},[l,r,i,t,n]),a.useEffect(()=>{h.current&&x&&(h.current.scrollTop=h.current.scrollHeight)},[x]);const F=async()=>{await E.logout(),I("/login")},C=e=>{!e&&m.current&&(m.current.abort(),m.current=null),k(e)},_=()=>{l&&C(!1),v(i,t)};return s.jsxs("div",{className:"flex h-screen",children:[s.jsx(Q,{onLogout:F,isOpen:O,onClose:()=>y(!1)}),s.jsxs("div",{className:"flex flex-1 flex-col min-w-0",children:[s.jsx(X,{hostname:"nixos-router",username:R,connectionStatus:D,onMenuClick:()=>y(!0)}),s.jsx("main",{className:"flex-1 overflow-auto p-4",children:s.jsx("div",{className:"mx-auto max-w-full",children:s.jsxs(W,{children:[s.jsx("h1",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Logs"}),s.jsxs("div",{className:"mb-4 flex flex-wrap items-end gap-4",children:[s.jsxs("div",{className:"min-w-[200px]",children:[s.jsx(p,{htmlFor:"log-source",className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Log to view"}),s.jsx(w,{id:"log-source",value:r,onChange:e=>N(e.target.value),disabled:l,children:S.map(e=>s.jsx("option",{value:e.id,children:e.label},e.id))})]}),s.jsxs("div",{className:"min-w-[120px]",children:[s.jsx(p,{htmlFor:"lines",className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Lines to view"}),s.jsx(w,{id:"lines",value:i,onChange:e=>P(Number(e.target.value)),disabled:l,children:Z.map(e=>s.jsx("option",{value:e,children:e},e))})]}),s.jsxs("div",{className:"min-w-[140px]",children:[s.jsx(p,{htmlFor:"log-level",className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Log level"}),s.jsx(w,{id:"log-level",value:t,onChange:e=>A(e.target.value),disabled:l,children:ee.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx($,{id:"follow",checked:l,onChange:e=>C(e.target.checked),disabled:f}),s.jsx(p,{htmlFor:"follow",className:"cursor-pointer text-sm text-gray-700 dark:text-gray-300",children:"Follow log (live tail, includes selected lines)"})]}),s.jsxs(z,{size:"sm",onClick:_,disabled:f||l,children:[s.jsx(M,{className:"mr-2 h-4 w-4"}),"Refresh"]})]}),L&&s.jsx("p",{className:"mb-2 text-sm text-red-600 dark:text-red-400",children:L}),f&&!x&&s.jsxs("div",{className:"flex items-center gap-2 py-4",children:[s.jsx(V,{size:"sm"}),s.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:l?"Connecting...":"Loading logs..."})]}),s.jsx("pre",{ref:h,className:"max-h-[70vh] overflow-auto rounded bg-gray-900 p-3 text-xs text-gray-100 font-mono whitespace-pre-wrap break-words",children:x||(f?"":"Select a log and click Refresh or enable Follow.")})]})})})]})]})}export{ne as Logs};
