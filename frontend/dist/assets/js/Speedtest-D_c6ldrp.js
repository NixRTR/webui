import{j as e,B as j,C as S,e as Y,f as Z,P as q,S as A,L as J,T as Q,b as n}from"./ui-vendor-BVL8hT-S.js";import{u as V,r as i}from"./react-vendor-DKKOAuGG.js";import{C as W}from"./CustomTooltip-h6IVXsCv.js";import{u as ee,S as te,N as se}from"./useMetrics-CHtIqUNb.js";import{a as ae}from"./index-9dKHPhJj.js";import{R as re,L as ne,C as ie,X as oe,Y as le,T as ce,a as de,b as E}from"./charts-B4vmDJji.js";import"./http-vendor-B9ygI19o.js";const me=[{value:1,label:"1 hour"},{value:3,label:"3 hours"},{value:6,label:"6 hours"},{value:12,label:"12 hours"},{value:24,label:"1 day"},{value:168,label:"1 week"},{value:336,label:"2 weeks"},{value:720,label:"1 month"},{value:2160,label:"3 months"},{value:4320,label:"6 months"},{value:8760,label:"1 year"}],ue=[10,25,50,100];function we(){const r=localStorage.getItem("access_token"),L=localStorage.getItem("username")||"Unknown",O=V(),[N,C]=i.useState(!1),{connectionStatus:B}=ee(r),[m,F]=i.useState(24),[H,k]=i.useState([]),[l,f]=i.useState(1),[u,$]=i.useState(25),[z,w]=i.useState(""),[M,v]=i.useState(!1),[h,D]=i.useState(null),[s,T]=i.useState({is_running:!1}),[c,R]=i.useState(null),g=i.useRef(null),U=async()=>{await ae.logout(),O("/login")};i.useEffect(()=>{const t=async()=>{if(r)try{const a=await fetch(`/api/speedtest/chart-data?hours=${m}`,{headers:{Authorization:`Bearer ${r}`}});if(a.ok){const d=await a.json();k(d.data||[])}}catch(a){console.error("Error fetching chart data:",a)}},o=async()=>{if(r)try{const a=new Date,d=new Date(a.getTime()-m*60*60*1e3),y=await fetch(`/api/speedtest/history?start_time=${d.toISOString()}&end_time=${a.toISOString()}&page=${l}&page_size=${u}`,{headers:{Authorization:`Bearer ${r}`}});if(y.ok){const _=await y.json();D(_)}}catch(a){console.error("Error fetching table data:",a)}},p=async()=>{await Promise.all([t(),o()])};p();const b=setInterval(p,3e4);return()=>clearInterval(b)},[r,m,l,u]),i.useEffect(()=>{(async()=>{if(r)try{const o=new Date,p=new Date(o.getTime()-720*60*60*1e3),b=await fetch(`/api/speedtest/history?start_time=${p.toISOString()}&end_time=${o.toISOString()}&page=1&page_size=1`,{headers:{Authorization:`Bearer ${r}`}});if(b.ok){const a=await b.json();a.results&&a.results.length>0&&R(a.results[0])}}catch(o){console.error("Error fetching last speedtest result:",o)}})()},[r]),i.useEffect(()=>{if(s.is_running){const t=async()=>{try{const o=await fetch("/api/speedtest/status",{headers:{Authorization:`Bearer ${r}`}});if(o.ok){const p=await o.json();T(p),!p.is_running&&s.is_running&&(async()=>{try{const a=await fetch(`/api/speedtest/chart-data?hours=${m}`,{headers:{Authorization:`Bearer ${r}`}});if(a.ok){const x=await a.json();k(x.data||[])}const d=new Date,y=new Date(d.getTime()-m*60*60*1e3),_=await fetch(`/api/speedtest/history?start_time=${y.toISOString()}&end_time=${d.toISOString()}&page=${l}&page_size=${u}`,{headers:{Authorization:`Bearer ${r}`}});if(_.ok){const x=await _.json();D(x)}const P=await fetch(`/api/speedtest/history?start_time=${new Date(d.getTime()-720*60*60*1e3).toISOString()}&end_time=${d.toISOString()}&page=1&page_size=1`,{headers:{Authorization:`Bearer ${r}`}});if(P.ok){const x=await P.json();x.results&&x.results.length>0&&R(x.results[0])}}catch(a){console.error("Error refreshing data after speedtest completion:",a)}})()}}catch(o){console.error("Error polling status:",o)}};return g.current=window.setInterval(t,1e3),()=>{g.current&&clearInterval(g.current)}}else g.current&&(clearInterval(g.current),g.current=null)},[s.is_running,r,m,l,u]);const K=async()=>{if(r)try{(await fetch("/api/speedtest/trigger",{method:"POST",headers:{Authorization:`Bearer ${r}`}})).ok&&T({is_running:!0,progress:0,current_phase:"starting",download_mbps:void 0,upload_mbps:void 0,ping_ms:void 0})}catch(t){console.error("Error triggering speedtest:",t)}},G=t=>{t==="custom"?v(!0):($(parseInt(t)),f(1),v(!1),w(""))},I=()=>{const t=parseInt(z);t>=1&&t<=200&&($(t),f(1),v(!1),w(""))},X=t=>new Date(t).toLocaleString();return e.jsxs("div",{className:"flex h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx(te,{isOpen:N,onClose:()=>C(!1),onLogout:U}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(se,{hostname:"nixos-router",username:L,connectionStatus:B,onMenuClick:()=>C(!N)}),e.jsx("main",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Speedtest"}),e.jsx(j,{onClick:K,disabled:s.is_running,color:"blue",children:s.is_running?"Running...":"Run Speedtest"})]}),e.jsx(S,{children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:s.is_running?"Speedtest in Progress":"Last Speedtest Result"}),c&&e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-6",children:new Date(c.timestamp).toLocaleString()}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-8 mb-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Download"}),e.jsx(Y,{className:`w-5 h-5 text-blue-600 dark:text-blue-400 ${s.is_running&&!s.download_mbps?"animate-pulse drop-shadow-lg":""}`,style:s.is_running&&!s.download_mbps?{filter:"drop-shadow(0 0 8px rgba(59, 130, 246, 0.8))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{}})]}),e.jsx("div",{className:`text-5xl font-bold text-blue-600 dark:text-blue-400 ${s.is_running&&!s.download_mbps?"drop-shadow-lg":""}`,style:s.is_running&&!s.download_mbps?{filter:"drop-shadow(0 0 12px rgba(59, 130, 246, 0.6))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{},children:s.is_running?s.download_mbps?`${s.download_mbps.toFixed(2)}`:"--":c?`${c.download_mbps.toFixed(2)}`:"--"}),e.jsx("div",{className:"text-lg text-gray-500 dark:text-gray-400 mt-1",children:"Mbps"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Upload"}),e.jsx(Z,{className:`w-5 h-5 text-green-600 dark:text-green-400 ${s.is_running&&!s.upload_mbps?"animate-pulse drop-shadow-lg":""}`,style:s.is_running&&!s.upload_mbps?{filter:"drop-shadow(0 0 8px rgba(16, 185, 129, 0.8))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{}})]}),e.jsx("div",{className:`text-5xl font-bold text-green-600 dark:text-green-400 ${s.is_running&&!s.upload_mbps?"drop-shadow-lg":""}`,style:s.is_running&&!s.upload_mbps?{filter:"drop-shadow(0 0 12px rgba(16, 185, 129, 0.6))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{},children:s.is_running?s.upload_mbps?`${s.upload_mbps.toFixed(2)}`:"--":c?`${c.upload_mbps.toFixed(2)}`:"--"}),e.jsx("div",{className:"text-lg text-gray-500 dark:text-gray-400 mt-1",children:"Mbps"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600 dark:text-gray-400 mb-2",children:"Ping"}),e.jsx("div",{className:`text-5xl font-bold text-gray-700 dark:text-gray-300 ${s.is_running&&!s.ping_ms?"drop-shadow-lg":""}`,style:s.is_running&&!s.ping_ms?{filter:"drop-shadow(0 0 12px rgba(107, 114, 128, 0.6))",animation:"pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite"}:{},children:s.is_running?s.ping_ms?`${s.ping_ms.toFixed(2)}`:"--":c?`${c.ping_ms.toFixed(2)}`:"--"}),e.jsx("div",{className:"text-lg text-gray-500 dark:text-gray-400 mt-1",children:"ms"})]})]}),s.is_running&&s.progress!==void 0&&e.jsxs("div",{className:"mt-4",children:[e.jsx(q,{progress:s.progress,color:"blue"}),e.jsx("div",{className:"text-sm text-gray-500 mt-2 text-center",children:s.current_phase||"Starting..."})]})]})}),e.jsxs(S,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"Speedtest Results"}),e.jsx(A,{value:m,onChange:t=>{F(parseInt(t.target.value)),f(1)},className:"w-48",children:me.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsx(re,{width:"100%",height:400,children:e.jsxs(ne,{data:H,children:[e.jsx(ie,{strokeDasharray:"3 3"}),e.jsx(oe,{dataKey:"timestamp",tickFormatter:t=>new Date(t).toLocaleTimeString()}),e.jsx(le,{label:{value:"Mbps",angle:-90,position:"insideLeft"}}),e.jsx(ce,{content:e.jsx(W,{})}),e.jsx(de,{}),e.jsx(E,{type:"monotone",dataKey:"download_mbps",stroke:"#3b82f6",name:"Download",dot:!1}),e.jsx(E,{type:"monotone",dataKey:"upload_mbps",stroke:"#10b981",name:"Upload",dot:!1})]})})]}),e.jsxs(S,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"Test History"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{htmlFor:"page-size",children:"Results per page:"}),M?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{id:"custom-page-size",type:"number",min:"1",max:"200",value:z,onChange:t=>w(t.target.value),onKeyPress:t=>{t.key==="Enter"&&I()},className:"w-20"}),e.jsx(j,{size:"sm",onClick:I,children:"Apply"}),e.jsx(j,{size:"sm",color:"gray",onClick:()=>{v(!1),w("")},children:"Cancel"})]}):e.jsxs(A,{id:"page-size",value:u.toString(),onChange:t=>G(t.target.value),className:"w-32",children:[ue.map(t=>e.jsx("option",{value:t.toString(),children:t},t)),e.jsx("option",{value:"custom",children:"Custom"})]})]})]}),e.jsxs(n,{children:[e.jsxs(n.Head,{children:[e.jsx(n.HeadCell,{children:"Timestamp"}),e.jsx(n.HeadCell,{children:"Download (Mbps)"}),e.jsx(n.HeadCell,{children:"Upload (Mbps)"}),e.jsx(n.HeadCell,{children:"Ping (ms)"}),e.jsx(n.HeadCell,{children:"Server"})]}),e.jsx(n.Body,{className:"divide-y",children:h?.results.map(t=>e.jsxs(n.Row,{children:[e.jsx(n.Cell,{children:X(t.timestamp)}),e.jsx(n.Cell,{children:t.download_mbps.toFixed(2)}),e.jsx(n.Cell,{children:t.upload_mbps.toFixed(2)}),e.jsx(n.Cell,{children:t.ping_ms.toFixed(2)}),e.jsx(n.Cell,{children:t.server_name||"-"})]},t.id))})]}),h&&h.total_pages>1&&e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["Showing ",(l-1)*u+1," to ",Math.min(l*u,h.total)," of ",h.total," results"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{size:"sm",color:"gray",disabled:l===1,onClick:()=>f(l-1),children:"Previous"}),e.jsx(j,{size:"sm",color:"gray",disabled:l===h.total_pages,onClick:()=>f(l+1),children:"Next"})]})]})]})]})})]})]})}export{we as Speedtest};
